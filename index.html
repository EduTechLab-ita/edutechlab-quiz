<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTech Lab - Pensiero Computazionale</title>
    <meta name="description" content="Piattaforma di Pensiero Computazionale per la Scuola Primaria">
    <meta name="theme-color" content="#3B82F6">
    
    <!-- PWA Meta Tags COMPLETI -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icona-72.png" sizes="72x72">
    <link rel="icon" href="icona-96.png" sizes="96x96">
    <link rel="icon" href="icona-128.png" sizes="128x128">
    <link rel="icon" href="icona-144.png" sizes="144x144">
    <link rel="icon" href="icona-152.png" sizes="152x152">
    <link rel="icon" href="icona-192.png" sizes="192x192">
    <link rel="icon" href="icona-384.png" sizes="384x384">
    <link rel="icon" href="icona-512.png" sizes="512x512">
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="EduTech Lab">
    <link rel="apple-touch-icon" href="icona-192.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icona-72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="icona-96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="icona-128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icona-144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icona-152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icona-192.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="icona-144.png">
    <meta name="msapplication-TileColor" content="#3B82F6">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1a1a1a;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .main-container {
            min-height: 100vh;
            position: relative;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .floating-shape {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        .floating-shape:nth-child(1) { top: 20%; left: 10%; width: 80px; height: 80px; animation-delay: 0s; }
        .floating-shape:nth-child(2) { top: 40%; left: 80%; width: 60px; height: 60px; animation-delay: 2s; }
        .floating-shape:nth-child(3) { top: 70%; left: 20%; width: 100px; height: 100px; animation-delay: 4s; }
        .floating-shape:nth-child(4) { top: 80%; left: 60%; width: 40px; height: 40px; animation-delay: 1s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        /* Header */
        .header {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            margin: 1rem;
            border-radius: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .header h2 {
            font-size: 1.5rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #6B7280;
            font-size: 1.1rem;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .stat-stars { background: #FEF3C7; color: #92400E; }
        .stat-score { background: #D1FAE5; color: #065F46; }
        .stat-level { background: #E0E7FF; color: #3730A3; }

        /* Classes Grid */
        .classes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .class-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }

        .card-description {
            color: #6B7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .card-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .badge {
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge.math { background: #EFF6FF; color: #1E40AF; }
        .badge.coding { background: #ECFDF5; color: #059669; }
        .badge.thinking { background: #FAF5FF; color: #7C3AED; }

        /* Games Section */
        .games-section {
            display: none;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* Navigation Buttons */
        .nav-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .reset-btn {
            background: #FEE2E2;
            color: #DC2626;
        }

        .reset-btn:hover {
            background: #FEF2F2;
        }

        /* Game Interface */
        .game-interface {
            display: none;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 2rem;
            margin: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .game-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Fullscreen Button */
        .fullscreen-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .fullscreen-btn:hover {
            background: #1976D2;
            transform: scale(1.1);
        }

        /* Fullscreen Mode */
        .fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }

        .fullscreen-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exit-fullscreen {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        /* Adaptive Learning Stats */
        .adaptive-stats {
            background: linear-gradient(135deg, #E8F5E8, #F0F8F0);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid #4CAF50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2E7D32;
        }

        .stat-label {
            color: #555;
            font-size: 0.9rem;
        }

        /* Hint System */
        .hint-container {
            background: #FFF3CD;
            border: 1px solid #FFEAA7;
            border-radius: 1rem;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .hint-icon {
            font-size: 2rem;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Difficulty Indicator */
        .difficulty-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .difficulty-star {
            font-size: 1.5rem;
            color: #ddd;
            transition: color 0.3s ease;
        }

        .difficulty-star.active {
            color: #FFD700;
        }

        /* Game Content Areas */
        .game-content {
            background: #f8f9fa;
            border-radius: 1rem;
            padding: 2rem;
            margin: 1rem 0;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .question {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 2rem;
            color: #333;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            width: 100%;
            max-width: 600px;
        }

        .answer-btn {
            padding: 1.5rem;
            font-size: 1.5rem;
            border: 2px solid #ddd;
            border-radius: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .answer-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.05);
        }

        .answer-btn.correct {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .answer-btn.wrong {
            background: #f44336;
            color: white;
            border-color: #d32f2f;
        }

        /* NUOVO: Visual Elements Layout Orizzontale Responsive */
        .counting-objects {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            justify-content: center;
            align-items: center;
            margin: 2rem 0;
            max-height: 40vh;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 1rem;
        }

        .visual-objects {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            margin: 2rem 0;
            max-height: 45vh;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 1rem;
        }

        .counting-object {
            font-size: clamp(1.5rem, 3vw, 2.5rem);
            padding: 0.3rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: clamp(50px, 8vw, 70px);
            height: clamp(50px, 8vw, 70px);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bounceIn 0.5s ease-out;
            flex-shrink: 0;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .visual-object {
            width: clamp(40px, 6vw, 60px);
            height: clamp(40px, 6vw, 60px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(0.8rem, 2vw, 1.2rem);
            font-weight: bold;
            color: white;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .visual-object:hover {
            transform: scale(1.1);
        }

        /* Addizioni Visual - NUOVO Layout Orizzontale */
        .addition-groups {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            justify-content: center;
            align-items: center;
            margin: 2rem 0;
            max-height: 50vh;
            overflow-y: auto;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 1.5rem;
        }

        .addition-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .group-label {
            font-size: 1.2rem;
            font-weight: bold;
            color: #374151;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 50px;
        }

        .objects-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
            gap: 0.5rem;
            max-width: 200px;
        }

        .operator {
            font-size: clamp(2rem, 4vw, 3rem);
            color: #667eea;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: clamp(60px, 8vw, 80px);
            height: clamp(60px, 8vw, 80px);
        }

        /* Pattern Game */
        .pattern-container {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 2rem 0;
        }

        .pattern-item {
            width: 80px;
            height: 80px;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            border: 3px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pattern-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .pattern-item.correct {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        /* Sequence Game - NUOVO Design Intuitivo */
        .sequence-instructions {
            background: #E3F2FD;
            border: 2px solid #2196F3;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .sequence-instructions h3 {
            color: #1976D2;
            margin-bottom: 0.5rem;
        }

        .sequence-story {
            background: #FFF9C4;
            border: 2px solid #FBC02D;
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: center;
        }

        .sequence-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
            max-width: 800px;
        }

        .sequence-option {
            background: white;
            border: 3px solid #E0E0E0;
            border-radius: 1rem;
            padding: 1rem;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            position: relative;
        }

        .sequence-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .sequence-option.selected {
            border-color: #4CAF50;
            background: #E8F5E8;
        }

        .sequence-number {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
        }

        /* CORRETTE: Frazioni Game con visualizzazione completa */
        .fraction-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 1.5rem;
            margin: 2rem 0;
        }

        .fraction-selector {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .fraction-type {
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 120px;
        }

        .fraction-type:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .fraction-type.active {
            border-color: #4CAF50;
            background: #E8F5E8;
        }

        .fraction-display {
            position: relative;
            margin: 2rem 0;
        }

        /* Pizza Visualization - CORRETTA */
        .pizza-container {
            position: relative;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background: #FFF3E0;
            border: 4px solid #FF6B35;
            overflow: hidden;
            margin: 0 auto;
        }

        .pizza-slice {
            position: absolute;
            width: 50%;
            height: 50%;
            border: 2px solid #FF6B35;
            cursor: pointer;
            transition: all 0.3s ease;
            transform-origin: 100% 100%;
            background: #FFF8DC;
            top: 50%;
            left: 50%;
        }

        .pizza-slice:hover {
            background: #FFE4B5;
            transform: scale(1.05);
        }

        .pizza-slice.filled {
            background: #FF6B35;
            background-image: 
                radial-gradient(circle at 30% 40%, #FF4500 8px, transparent 8px),
                radial-gradient(circle at 70% 30%, #DC143C 6px, transparent 6px),
                radial-gradient(circle at 40% 80%, #228B22 5px, transparent 5px),
                radial-gradient(circle at 80% 70%, #FFD700 4px, transparent 4px);
        }

        /* Chocolate Bar Visualization */
        .chocolate-container {
            display: grid;
            gap: 2px;
            background: #8B4513;
            padding: 8px;
            border-radius: 8px;
            border: 3px solid #654321;
            margin: 0 auto;
        }

        .chocolate-piece {
            background: #D2691E;
            border: 1px solid #8B4513;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #654321;
        }

        .chocolate-piece:hover {
            background: #CD853F;
        }

        .chocolate-piece.filled {
            background: #654321;
            color: #D2691E;
        }

        /* Cake Visualization */
        .cake-container {
            position: relative;
            width: 200px;
            height: 100px;
            background: #FFB6C1;
            border: 3px solid #FF69B4;
            border-radius: 0 0 50% 50%;
            margin: 0 auto;
            overflow: hidden;
        }

        .cake-slice {
            position: absolute;
            height: 100%;
            border-right: 2px solid #FF69B4;
            background: #FFC0CB;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #8B008B;
        }

        .cake-slice:hover {
            background: #FFB6C1;
        }

        .cake-slice.filled {
            background: #FF1493;
            color: white;
        }

        /* Fraction Info */
        .fraction-info {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            min-width: 250px;
        }

        .fraction-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .fraction-stat {
            text-align: center;
        }

        .fraction-stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .fraction-stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* Info Project Section */
        .info-project {
            background: linear-gradient(135deg, white 0%, #EFF6FF 100%);
            border-radius: 2rem;
            padding: 3rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin: 2rem 1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            text-align: center;
        }

        .info-card {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-icon {
            width: 80px;
            height: 80px;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 2rem;
        }

        .icon-math { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); }
        .icon-coding { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .icon-thinking { background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%); }

        /* Footer */
        .footer {
            background: rgba(31, 41, 55, 0.95);
            color: white;
            text-align: center;
            padding: 2rem;
            margin: 2rem 1rem;
            border-radius: 1rem;
            backdrop-filter: blur(10px);
        }

        .footer h3 {
            color: #60A5FA;
            margin-bottom: 0.5rem;
        }

        /* NUOVO: Colophon per pagine interne */
        .colophon {
            background: rgba(255, 255, 255, 0.9);
            color: #666;
            text-align: center;
            padding: 1rem;
            margin: 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            border-top: 2px solid #e2e8f0;
        }

        .colophon p {
            margin-bottom: 0.5rem;
        }

        .colophon .copyright {
            font-weight: bold;
            color: #374151;
        }

        /* Success/Error Messages */
        .message {
            padding: 1rem;
            border-radius: 1rem;
            margin: 1rem 0;
            text-align: center;
            font-weight: bold;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.hint {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Back to Site Button */
        .back-to-site {
            background: #607D8B;
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-to-site:hover {
            background: #455A64;
            transform: translateY(-2px);
            text-decoration: none;
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .classes-grid {
                grid-template-columns: 1fr;
                padding: 0.5rem;
            }
            
            .class-card {
                padding: 1.5rem;
            }
            
            .game-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .question {
                font-size: 1.5rem;
            }
            
            .answers-grid {
                grid-template-columns: 1fr;
                max-width: 300px;
            }

            .stats-bar {
                flex-direction: column;
                align-items: center;
            }

            .addition-groups {
                flex-direction: column;
                gap: 1rem;
            }

            .operator {
                width: 50px;
                height: 50px;
                font-size: 2rem;
            }

            .pizza-container {
                width: 200px;
                height: 200px;
            }

            .fraction-selector {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>

    <div class="main-container">
        <!-- Homepage: Scelta Classe -->
        <div id="homepage">
            <header class="header">
                <h1>üéì EduTech Lab</h1>
                <h2>Pensiero Computazionale per la Scuola Primaria</h2>
                <p>Scegli la tua classe e inizia il viaggio nel mondo del coding!</p>
            </header>

            <!-- Stats Bar (visible when there are points) -->
            <div id="stats-bar" class="stats-bar" style="display: none;">
                <div class="stat-item stat-stars">‚≠ê <span id="stars-count">0</span> stelle</div>
                <div class="stat-item stat-score">üèÜ <span id="score-count">0</span> punti</div>
                <div class="stat-item stat-level">üß† Livello <span id="level-count">1</span></div>
                <button class="nav-btn reset-btn" onclick="resetProgress()">üîÑ Reset</button>
            </div>

            <div class="classes-grid">
                <div class="class-card" onclick="selectClass(1)">
                    <div class="card-emoji">üå±</div>
                    <h3 class="card-title">Classe 1¬™</h3>
                    <p class="card-description">I primi passi nel mondo digitale (6-7 anni)</p>
                    <div class="card-badges">
                        <span class="badge math">Conteggio</span>
                        <span class="badge coding">Sequenze</span>
                        <span class="badge thinking">Pattern</span>
                    </div>
                    <div style="color: #059669; font-weight: bold;">‚úÖ 4 Giochi attivi</div>
                </div>

                <div class="class-card" onclick="selectClass(2)">
                    <div class="card-emoji">üåø</div>
                    <h3 class="card-title">Classe 2¬™</h3>
                    <p class="card-description">Esploratori digitali curiosi (7-8 anni)</p>
                    <div class="card-badges">
                        <span class="badge math">Operazioni</span>
                        <span class="badge coding">Debug</span>
                        <span class="badge thinking">Pattern</span>
                    </div>
                    <div style="color: #059669; font-weight: bold;">‚úÖ 6 Giochi attivi</div>
                </div>

                <div class="class-card" onclick="selectClass(3)">
                    <div class="card-emoji">üå≥</div>
                    <h3 class="card-title">Classe 3¬™</h3>
                    <p class="card-description">Logica e primi algoritmi (8-9 anni)</p>
                    <div class="card-badges">
                        <span class="badge math">Tabelline</span>
                        <span class="badge coding">Loop</span>
                        <span class="badge thinking">Condizioni</span>
                    </div>
                    <div style="color: #059669; font-weight: bold;">‚úÖ 7 Giochi attivi</div>
                </div>

                <div class="class-card" onclick="selectClass(4)">
                    <div class="card-emoji">üå≤</div>
                    <h3 class="card-title">Classe 4¬™</h3>
                    <p class="card-description">Algoritmi avanzati (9-10 anni)</p>
                    <div class="card-badges">
                        <span class="badge math">Frazioni</span>
                        <span class="badge coding">Variabili</span>
                        <span class="badge thinking">Ottimizzazione</span>
                    </div>
                    <div style="color: #059669; font-weight: bold;">‚úÖ 8 Giochi attivi</div>
                </div>

                <div class="class-card" onclick="selectClass(5)">
                    <div class="card-emoji">üå∫</div>
                    <h3 class="card-title">Classe 5¬™</h3>
                    <p class="card-description">Programmatori junior (10-11 anni)</p>
                    <div class="card-badges">
                        <span class="badge math">Statistiche</span>
                        <span class="badge coding">Progetti</span>
                        <span class="badge thinking">Collaborazione</span>
                    </div>
                    <div style="color: #059669; font-weight: bold;">‚úÖ 9 Giochi attivi</div>
                </div>
            </div>

            <!-- Info Project -->
            <div class="info-project">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="font-size: 2rem; color: #1F2937; margin-bottom: 1rem;">üöÄ EduTech Lab Platform</h3>
                    <p style="color: #6B7280; max-width: 600px; margin: 0 auto;">
                        Piattaforma integrata per lo sviluppo del pensiero computazionale nella scuola primaria.
                    </p>
                </div>
                
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-icon icon-math">üßÆ</div>
                        <h4 style="color: #2563EB; font-size: 1.2rem; margin-bottom: 0.5rem;">Matematica</h4>
                        <p style="color: #6B7280; font-size: 0.9rem;">Conteggio, operazioni e problem solving</p>
                    </div>
                    <div class="info-card">
                        <div class="info-icon icon-coding">üíª</div>
                        <h4 style="color: #059669; font-size: 1.2rem; margin-bottom: 0.5rem;">Coding</h4>
                        <p style="color: #6B7280; font-size: 0.9rem;">Algoritmi, sequenze e robotica educativa</p>
                    </div>
                    <div class="info-card">
                        <div class="info-icon icon-thinking">üß†</div>
                        <h4 style="color: #7C3AED; font-size: 1.2rem; margin-bottom: 0.5rem;">Pensiero Computazionale</h4>
                        <p style="color: #6B7280; font-size: 0.9rem;">Pattern recognition e debugging</p>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <div style="margin-bottom: 1rem;">
                    <a href="https://edutechlab-ita.github.io" class="back-to-site" target="_blank">
                        üåê Torna al Sito EduTech Lab
                    </a>
                </div>
                <h3>üéì EduTech Lab</h3>
                <p style="margin-bottom: 0.5rem;">Piattaforma di Pensiero Computazionale per la Scuola Primaria</p>
                <p style="font-size: 0.9rem; color: #9CA3AF;">
                    ¬© 2025 EduTech Lab by <strong style="color: #60A5FA;">Fabio Rizzotto</strong>
                </p>
                <p style="font-size: 0.8rem; color: #9CA3AF;">
                    Insegnante | Animatore Digitale | Formatore Docenti | Esperto PNRR
                </p>
            </footer>
        </div>

        <!-- Sezione Giochi per Classe -->
        <div id="gamesSection" class="games-section">
            <div class="game-header">
                <h2 id="classTitle">Classe selezionata</h2>
                <button class="nav-btn" onclick="backToHome()">üè† Torna alla Home</button>
            </div>

            <div class="adaptive-stats">
                <h3>üìä Le tue statistiche di apprendimento</h3>
                <div class="stats-grid">
                    <div style="text-align: center;">
                        <div class="stat-number" id="totalQuestions">0</div>
                        <div class="stat-label">Domande totali</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="stat-number" id="correctAnswers">0</div>
                        <div class="stat-label">Risposte corrette</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="stat-number" id="accuracyRate">0%</div>
                        <div class="stat-label">Precisione</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="stat-number" id="currentLevel">1</div>
                        <div class="stat-label">Livello attuale</div>
                    </div>
                </div>
            </div>

            <div class="games-grid" id="gamesGrid">
                <!-- I giochi verranno caricati dinamicamente -->
            </div>

            <!-- Colophon per pagina Giochi -->
            <div class="colophon">
                <p><strong>EduTech Lab</strong> - Piattaforma di Pensiero Computazionale</p>
                <p class="copyright">¬© 2025 Fabio Rizzotto - Tutti i diritti riservati</p>
            </div>
        </div>

        <!-- Interfaccia Gioco -->
        <div id="gameInterface" class="game-interface">
            <div class="game-header">
                <div>
                    <h2 id="gameTitle">Gioco</h2>
                    <div class="difficulty-indicator">
                        <span>Difficolt√†:</span>
                        <span class="difficulty-star" data-level="1">‚≠ê</span>
                        <span class="difficulty-star" data-level="2">‚≠ê</span>
                        <span class="difficulty-star" data-level="3">‚≠ê</span>
                        <span class="difficulty-star" data-level="4">‚≠ê</span>
                        <span class="difficulty-star" data-level="5">‚≠ê</span>
                    </div>
                </div>
                <div class="game-controls">
                    <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Schermo intero">‚õ∂</button>
                    <button class="btn btn-secondary" onclick="backToGames()">üéÆ Torna ai Giochi</button>
                </div>
            </div>

            <div class="hint-container" id="hintContainer">
                <span class="hint-icon">üí°</span>
                <div id="hintText">Suggerimento apparir√† qui...</div>
            </div>

            <div class="message" id="messageContainer"></div>

            <div class="game-content" id="gameContent">
                <!-- Il contenuto del gioco verr√† caricato qui -->
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="nextQuestion()">üîÑ Prossima Domanda</button>
                <button class="btn btn-success" onclick="checkAnswer()" style="display: none;" id="checkAnswerBtn">‚úÖ Verifica Risposta</button>
            </div>

            <!-- Colophon per pagina Gioco -->
            <div class="colophon">
                <p><strong>EduTech Lab</strong> - Piattaforma di Pensiero Computazionale</p>
                <p class="copyright">¬© 2025 Fabio Rizzotto - Tutti i diritti riservati</p>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentClass = 1;
        let currentGame = '';
        let currentFractionType = 'pizza'; // pizza, chocolate, cake
        let adaptiveData = {
            consecutiveCorrect: 0,
            consecutiveWrong: 0,
            totalQuestions: 0,
            correctAnswers: 0,
            currentDifficulty: 1,
            maxDifficulty: 5,
            hintLevel: 0
        };

        // Game State
        let gameState = {
            currentQuestion: null,
            userAnswer: null,
            isAnswered: false
        };

        // Progress tracking
        let score = parseInt(localStorage.getItem('edutech_score') || '0');
        let stars = parseInt(localStorage.getItem('edutech_stars') || '0');
        let level = parseInt(localStorage.getItem('edutech_level') || '1');

        // NUOVO: Generatori dinamici per contenuti infiniti
        const contentGenerators = {
            animals: ['üê±', 'üê∂', 'üê∏', 'ü¶ã', 'üê¢', 'üê∞', 'ü¶ä', 'üêª', 'ü¶Ü', 'üêß', 'üêô', 'üê†', 'ü¶Ä', 'üêù', 'üêõ'],
            fruits: ['üçé', 'üçå', 'üçì', 'üçä', 'üçí', 'ü•ù', 'üçá', 'üçë', 'ü•≠', 'üçê', 'ü´ê', 'ü••', 'üçà', 'üçã', 'ü•ï'],
            objects: ['‚öΩ', 'üéà', 'üåü', 'üéÅ', 'üìö', 'üß∏', 'üöó', '‚úèÔ∏è', 'üé®', 'üß©', 'üéµ', 'üèÄ', 'üé™', 'üé≠', 'üéØ'],
            colors: ['üî¥', 'üîµ', 'üü°', 'üü¢', 'üü†', 'üü£', 'üü§', '‚ö´', '‚ö™', 'üü•', 'üü¶', 'üü®', 'üü©', 'üüß', 'üü™'],
            shapes: ['‚≠ê', 'üî∂', 'üî∑', '‚¨ú', '‚¨õ', 'üî∏', 'üîπ', 'üü¢', 'üî¥', 'üü°', 'üîµ', 'üü£', 'üü†', 'üü§', '‚ö™'],
            
            // Generatori per sequenze italiane
            dailyRoutines: [
                {
                    name: 'Mattino a Scuola',
                    sequence: [
                        { emoji: 'üõèÔ∏è', text: 'Mi sveglio' },
                        { emoji: 'ü¶∑', text: 'Mi lavo i denti' },
                        { emoji: 'üçû', text: 'Faccio colazione' },
                        { emoji: 'üéí', text: 'Preparo lo zaino' },
                        { emoji: 'üöå', text: 'Vado a scuola' }
                    ]
                },
                {
                    name: 'Preparare una Pizza',
                    sequence: [
                        { emoji: 'üåæ', text: 'Preparo la farina' },
                        { emoji: 'üíß', text: 'Aggiungo acqua' },
                        { emoji: 'ü§≤', text: 'Impasto' },
                        { emoji: 'üçÖ', text: 'Metto il pomodoro' },
                        { emoji: 'üßÄ', text: 'Aggiungo il formaggio' }
                    ]
                },
                {
                    name: 'Piantare un Seme',
                    sequence: [
                        { emoji: 'üå±', text: 'Prendo il seme' },
                        { emoji: 'ü™£', text: 'Riempio il vaso' },
                        { emoji: '‚òÇÔ∏è', text: 'Faccio un buco' },
                        { emoji: 'üå±', text: 'Metto il seme' },
                        { emoji: 'üíß', text: 'Innaffio' }
                    ]
                },
                {
                    name: 'Fare i Compiti',
                    sequence: [
                        { emoji: 'üéí', text: 'Apro lo zaino' },
                        { emoji: 'üìö', text: 'Prendo i libri' },
                        { emoji: '‚úèÔ∏è', text: 'Preparo matita e penna' },
                        { emoji: 'üìù', text: 'Scrivo i compiti' },
                        { emoji: 'üìö', text: 'Ripongo tutto' }
                    ]
                }
            ],

            // Generatori per variabili pi√π interessanti
            variableScenarios: [
                {
                    context: 'videogioco',
                    variables: [
                        { name: 'vite', description: 'le vite del personaggio', min: 1, max: 5 },
                        { name: 'livello', description: 'il livello raggiunto', min: 1, max: 10 },
                        { name: 'monete', description: 'le monete raccolte', min: 10, max: 100 },
                        { name: 'energia', description: 'l\'energia rimasta', min: 20, max: 100 }
                    ]
                },
                {
                    context: 'scuola',
                    variables: [
                        { name: 'compiti', description: 'i compiti da fare', min: 1, max: 8 },
                        { name: 'voto', description: 'il voto della verifica', min: 6, max: 10 },
                        { name: 'pagine', description: 'le pagine lette', min: 5, max: 50 },
                        { name: 'amici', description: 'gli amici in classe', min: 15, max: 25 }
                    ]
                },
                {
                    context: 'cucina',
                    variables: [
                        { name: 'ingredienti', description: 'gli ingredienti per la ricetta', min: 3, max: 8 },
                        { name: 'minuti', description: 'i minuti di cottura', min: 10, max: 60 },
                        { name: 'porzioni', description: 'le porzioni del dolce', min: 4, max: 12 },
                        { name: 'temperatura', description: 'i gradi del forno', min: 160, max: 200 }
                    ]
                }
            ],

            // Generatori per algoritmi pi√π interessanti
            algorithmChallenges: [
                {
                    type: 'ordinamento',
                    scenarios: [
                        { task: 'Ordinare i bambini per altezza', items: 'bambini', criteria: 'altezza' },
                        { task: 'Mettere i libri in ordine alfabetico', items: 'libri', criteria: 'titolo' },
                        { task: 'Sistemare i numeri dal pi√π piccolo', items: 'numeri', criteria: 'valore' },
                        { task: 'Organizzare i colori per intensit√†', items: 'colori', criteria: 'intensit√†' }
                    ]
                },
                {
                    type: 'ricerca',
                    scenarios: [
                        { task: 'Trovare il libro giusto nella biblioteca', strategy: 'dividere gli scaffali' },
                        { task: 'Cercare un amico nel parco', strategy: 'guardare nelle aree pi√π frequentate' },
                        { task: 'Trovare la chiave di casa', strategy: 'controllare i posti usuali' },
                        { task: 'Scegliere il regalo perfetto', strategy: 'pensare ai gusti della persona' }
                    ]
                }
            ]
        };

        // Classes and Games Data - AGGIORNATO
        const classesData = {
            1: {
                name: "Prima Primaria",
                emoji: "üå±",
                description: "I primi passi nel mondo digitale",
                age: "6-7 anni",
                games: [
                    { id: 'conteggio', name: 'üî¢ Conteggio Magico', description: 'Conta oggetti e associa al numero' },
                    { id: 'addizioni-visual', name: '‚ûï Addizioni Visual', description: 'Somme fino a 10 con oggetti colorati' },
                    { id: 'sequenze-base', name: 'üìù Prime Sequenze', description: 'Ordinare azioni quotidiane' },
                    { id: 'pattern-semplici', name: 'üåà Trova il Pattern', description: 'Riconosci sequenze colorate' }
                ]
            },
            2: {
                name: "Seconda Primaria",
                emoji: "üåø",
                description: "Esploratori digitali curiosi",
                age: "7-8 anni",
                games: [
                    { id: 'conteggio', name: 'üî¢ Conteggio Avanzato', description: 'Conta oggetti fino a 20' },
                    { id: 'operazioni-entro-20', name: 'üßÆ Operazioni entro il 20', description: 'Addizioni e sottrazioni veloci' },
                    { id: 'addizioni-visual', name: '‚ûï Addizioni Avanzate', description: 'Somme con raggruppamenti' },
                    { id: 'pattern-semplici', name: 'üé® Pattern Creativi', description: 'Pattern pi√π complessi' },
                    { id: 'sequenze-base', name: 'üìù Sequenze Avanzate', description: 'Storie pi√π articolate' },
                    { id: 'debugging-visuale', name: 'üêõ Detective del Codice', description: 'Trova gli errori nelle sequenze' }
                ]
            },
            3: {
                name: "Terza Primaria",
                emoji: "üå≥",
                description: "Logica e primi algoritmi",
                age: "8-9 anni",
                games: [
                    { id: 'conteggio', name: 'üî¢ Conteggio Strategico', description: 'Strategie di conteggio efficaci' },
                    { id: 'operazioni-entro-20', name: 'üßÆ Operazioni Rapide', description: 'Calcolo mentale veloce' },
                    { id: 'tabelline-base', name: '‚úñÔ∏è Tabelline Interattive', description: 'Moltiplicazioni fino alla tavola del 5' },
                    { id: 'addizioni-visual', name: '‚ûï Operazioni Complesse', description: 'Addizioni e sottrazioni avanzate' },
                    { id: 'loop-semplici', name: 'üîÑ I Miei Primi Loop', description: 'Ripetizioni e cicli semplici' },
                    { id: 'if-then-base', name: 'ü§î Se... Allora...', description: 'Prime condizioni logiche' },
                    { id: 'debugging-visuale', name: 'üêõ Debug Master', description: 'Debugging di algoritmi' }
                ]
            },
            4: {
                name: "Quarta Primaria",
                emoji: "üå≤",
                description: "Algoritmi avanzati",
                age: "9-10 anni",
                games: [
                    { id: 'conteggio', name: 'üî¢ Conteggio Professionale', description: 'Strategie avanzate di conteggio' },
                    { id: 'operazioni-entro-20', name: 'üßÆ Calcoli Complessi', description: 'Operazioni con numeri grandi' },
                    { id: 'tabelline-base', name: '‚úñÔ∏è Tabelline Complete', description: 'Tutte le tabelline fino al 10' },
                    { id: 'frazioni-visual', name: 'üçï Frazioni Interattive', description: 'Visualizza e opera con le frazioni' },
                    { id: 'addizioni-visual', name: '‚ûï Aritmetica Avanzata', description: 'Operazioni con numeri decimali' },
                    { id: 'variabili-semplici', name: 'üì¶ Le Mie Prime Variabili', description: 'Contenitori per i dati' },
                    { id: 'algoritmi-avanzati', name: 'üß† Algoritmi Intelligenti', description: 'Strategie di risoluzione complesse' },
                    { id: 'debugging-visuale', name: 'üêõ Debug Expert', description: 'Debugging avanzato' }
                ]
            },
            5: {
                name: "Quinta Primaria",
                emoji: "üå∫",
                description: "Programmatori junior",
                age: "10-11 anni",
                games: [
                    { id: 'conteggio', name: 'üî¢ Conteggio Esperto', description: 'Metodi di conteggio combinatorio' },
                    { id: 'operazioni-entro-20', name: 'üßÆ Matematica Superiore', description: 'Operazioni con tutti i numeri' },
                    { id: 'tabelline-base', name: '‚úñÔ∏è Moltiplicazioni Expert', description: 'Calcoli rapidi e trucchi' },
                    { id: 'frazioni-visual', name: 'üçï Frazioni Master', description: 'Operazioni con frazioni' },
                    { id: 'statistica-base', name: 'üìä I Miei Primi Grafici', description: 'Raccogli e analizza dati' },
                    { id: 'variabili-semplici', name: 'üì¶ Variabili Avanzate', description: 'Programmazione con variabili' },
                    { id: 'algoritmi-avanzati', name: 'üß† Algoritmi Pro', description: 'Ottimizzazione e ricerca' },
                    { id: 'progetti-completi', name: 'üéÆ Crea il Tuo Gioco', description: 'Progetti completi con interfaccia' },
                    { id: 'collaborazione-digitale', name: 'ü§ù Coding di Squadra', description: 'Progetti collaborativi' }
                ]
            }
        };

        // PWA Installation - AUTOMATICA (RIMOSSO pulsante download)
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Non preveniamo l'evento, lasciamo che il browser mostri il prompt naturalmente
            deferredPrompt = e;
            console.log('PWA installable');
        });

        // Load saved data
        function loadAdaptiveData() {
            const saved = localStorage.getItem('edutech_adaptive');
            if (saved) {
                adaptiveData = { ...adaptiveData, ...JSON.parse(saved) };
            }
            updateStatsDisplay();
        }

        // Save adaptive data
        function saveAdaptiveData() {
            localStorage.setItem('edutech_adaptive', JSON.stringify(adaptiveData));
            updateStatsDisplay();
        }

        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('totalQuestions').textContent = adaptiveData.totalQuestions;
            document.getElementById('correctAnswers').textContent = adaptiveData.correctAnswers;
            
            const accuracy = adaptiveData.totalQuestions > 0 ? 
                Math.round((adaptiveData.correctAnswers / adaptiveData.totalQuestions) * 100) : 0;
            document.getElementById('accuracyRate').textContent = accuracy + '%';
            document.getElementById('currentLevel').textContent = adaptiveData.currentDifficulty;

            // Update difficulty stars
            document.querySelectorAll('.difficulty-star').forEach((star, index) => {
                star.classList.toggle('active', index < adaptiveData.currentDifficulty);
            });

            // Update all displays
            document.querySelectorAll('#stars-count, #class-stars').forEach(el => {
                el.textContent = stars;
            });
            document.querySelectorAll('#score-count, #class-score').forEach(el => {
                el.textContent = score;
            });
            document.querySelectorAll('#level-count, #class-level').forEach(el => {
                el.textContent = level;
            });

            // Show stats if progress made
            if (score > 0 || stars > 0) {
                document.getElementById('stats-bar').style.display = 'flex';
            }
        }

        // NUOVE FUNZIONI: Generatori di contenuto dinamico

        function getRandomElements(array, count) {
            const shuffled = [...array].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function generateDynamicNumbers(min, max, exclude = []) {
            const numbers = [];
            for (let i = min; i <= max; i++) {
                if (!exclude.includes(i)) numbers.push(i);
            }
            return numbers.sort(() => 0.5 - Math.random());
        }

        // Class selection
        function selectClass(classNum) {
            currentClass = classNum;
            const classData = classesData[classNum];
            
            document.getElementById('homepage').style.display = 'none';
            document.getElementById('gamesSection').style.display = 'block';
            document.getElementById('classTitle').textContent = 
                `${classData.emoji} ${classData.name} - ${classData.description}`;
            
            loadGamesForClass(classNum);
        }

        // Load games for selected class
        function loadGamesForClass(classNum) {
            const games = classesData[classNum].games;
            const gamesGrid = document.getElementById('gamesGrid');
            gamesGrid.innerHTML = '';

            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card';
                gameCard.onclick = () => startGame(game.id, game.name);
                
                gameCard.innerHTML = `
                    <h3>${game.name}</h3>
                    <p>${game.description}</p>
                    <div style="margin-top: 1rem; color: #059669; font-weight: bold;">
                        ‚úÖ Gioco attivo
                    </div>
                `;
                
                gamesGrid.appendChild(gameCard);
            });
        }

        // Start a game
        function startGame(gameId, gameName) {
            currentGame = gameId;
            
            document.getElementById('gamesSection').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'block';
            document.getElementById('gameTitle').textContent = gameName;
            
            // Reset game state
            gameState = {
                currentQuestion: null,
                userAnswer: null,
                isAnswered: false
            };
            
            // Hide hint initially
            document.getElementById('hintContainer').style.display = 'none';
            
            generateQuestion();
        }

        // Generate question based on current game and difficulty
        function generateQuestion() {
            gameState.isAnswered = false;
            document.getElementById('checkAnswerBtn').style.display = 'none';
            hideMessage();
            hideHint();

            switch (currentGame) {
                case 'conteggio':
                    generateCountingQuestion();
                    break;
                case 'addizioni-visual':
                    generateAdditionQuestion();
                    break;
                case 'operazioni-entro-20':
                    generateOperationsQuestion();
                    break;
                case 'sequenze-base':
                    generateSequenceQuestion();
                    break;
                case 'pattern-semplici':
                    generatePatternQuestion();
                    break;
                case 'debugging-visuale':
                    generateDebuggingQuestion();
                    break;
                case 'tabelline-base':
                    generateMultiplicationQuestion();
                    break;
                case 'loop-semplici':
                    generateLoopQuestion();
                    break;
                case 'if-then-base':
                    generateConditionalQuestion();
                    break;
                case 'frazioni-visual':
                    generateFractionQuestion();
                    break;
                case 'variabili-semplici':
                    generateVariableQuestion();
                    break;
                case 'algoritmi-avanzati':
                    generateAlgorithmQuestion();
                    break;
                case 'statistica-base':
                    generateStatisticsQuestion();
                    break;
                case 'progetti-completi':
                    generateProjectQuestion();
                    break;
                case 'collaborazione-digitale':
                    generateCollaborationQuestion();
                    break;
                default:
                    generateCountingQuestion();
            }
        }

        // MIGLIORATA: Counting Game con oggetti dinamici
        function generateCountingQuestion() {
            const classLevel = currentClass;
            let max;
            
            switch(classLevel) {
                case 1: max = Math.min(5 + adaptiveData.currentDifficulty * 2, 10); break;
                case 2: max = Math.min(8 + adaptiveData.currentDifficulty * 3, 20); break;
                case 3: max = Math.min(10 + adaptiveData.currentDifficulty * 4, 30); break;
                case 4: max = Math.min(15 + adaptiveData.currentDifficulty * 5, 50); break;
                case 5: max = Math.min(20 + adaptiveData.currentDifficulty * 6, 100); break;
                default: max = 10;
            }
            
            const count = Math.floor(Math.random() * max) + 1;
            
            // Scegli categoria casuale per variet√†
            const categories = Object.keys(contentGenerators).filter(key => Array.isArray(contentGenerators[key]));
            const selectedCategory = categories[Math.floor(Math.random() * categories.length)];
            const objects = contentGenerators[selectedCategory];
            const selectedObject = objects[Math.floor(Math.random() * objects.length)];
            
            gameState.currentQuestion = {
                count: count,
                object: selectedObject
            };

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Conta tutti gli oggetti!</div>
                <div class="counting-objects">
                    ${Array(count).fill(selectedObject).map((obj, i) => 
                        `<div class="counting-object" style="animation-delay: ${i * 0.1}s">${obj}</div>`
                    ).join('')}
                </div>
                <div class="answers-grid">
                    ${generateNumberOptions(count, 4).map(num => 
                        `<button class="answer-btn" onclick="selectAnswer(${num})">${num}</button>`
                    ).join('')}
                </div>
            `;
        }

        // MIGLIORATA: Addition Game con layout orizzontale
        function generateAdditionQuestion() {
            const classLevel = currentClass;
            let maxNum;
            
            switch(classLevel) {
                case 1: maxNum = Math.min(5 + adaptiveData.currentDifficulty, 10); break;
                case 2: maxNum = Math.min(8 + adaptiveData.currentDifficulty * 2, 15); break;
                case 3: maxNum = Math.min(10 + adaptiveData.currentDifficulty * 3, 20); break;
                case 4: maxNum = Math.min(15 + adaptiveData.currentDifficulty * 4, 50); break;
                case 5: maxNum = Math.min(20 + adaptiveData.currentDifficulty * 5, 100); break;
                default: maxNum = 10;
            }
            
            const a = Math.floor(Math.random() * maxNum) + 1;
            const b = Math.floor(Math.random() * (maxNum - a)) + 1;
            const result = a + b;
            
            gameState.currentQuestion = {
                a: a,
                b: b,
                result: result
            };

            const useVisual = classLevel <= 3; // Solo per le prime 3 classi
            
            document.getElementById('gameContent').innerHTML = `
                <div class="question">${a} + ${b} = ?</div>
                ${useVisual ? `
                <div class="addition-groups">
                    <div class="addition-group">
                        <div class="group-label">Primo gruppo</div>
                        <div class="objects-container">
                            ${Array(a).fill('').map((_, i) => 
                                `<div class="visual-object" style="background: #3B82F6; animation-delay: ${i * 0.1}s;">${i+1}</div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="operator">+</div>
                    <div class="addition-group">
                        <div class="group-label">Secondo gruppo</div>
                        <div class="objects-container">
                            ${Array(b).fill('').map((_, i) => 
                                `<div class="visual-object" style="background: #EF4444; animation-delay: ${(a + i) * 0.1}s;">${i+1}</div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="operator">=</div>
                    <div class="addition-group">
                        <div class="group-label">Risultato</div>
                        <div style="font-size: 3rem; color: #4CAF50;">?</div>
                    </div>
                </div>
                ` : ''}
                <div class="answers-grid">
                    ${generateNumberOptions(result, 4).map(num => 
                        `<button class="answer-btn" onclick="selectAnswer(${num})">${num}</button>`
                    ).join('')}
                </div>
            `;
        }

        // Operations Question (Classe 2+) - Dinamica
        function generateOperationsQuestion() {
            const operations = ['+', '-'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            const max = Math.min(10 + adaptiveData.currentDifficulty * 3, 30);
            
            let a, b, result;
            if (operation === '+') {
                a = Math.floor(Math.random() * max) + 1;
                b = Math.floor(Math.random() * (max - a)) + 1;
                result = a + b;
            } else {
                result = Math.floor(Math.random() * max) + 1;
                b = Math.floor(Math.random() * result) + 1;
                a = result + b;
                result = a - b;
            }
            
            gameState.currentQuestion = { result: result };

            document.getElementById('gameContent').innerHTML = `
                <div class="question">${a} ${operation} ${b} = ?</div>
                <div class="answers-grid">
                    ${generateNumberOptions(result, 4).map(num => 
                        `<button class="answer-btn" onclick="selectAnswer(${num})">${num}</button>`
                    ).join('')}
                </div>
            `;
        }

        // Multiplication Question (Classe 3+) - Dinamica
        function generateMultiplicationQuestion() {
            const classLevel = currentClass;
            let maxTable;
            
            switch(classLevel) {
                case 3: maxTable = Math.min(3 + adaptiveData.currentDifficulty, 5); break;
                case 4: maxTable = Math.min(5 + adaptiveData.currentDifficulty, 8); break;
                case 5: maxTable = Math.min(7 + adaptiveData.currentDifficulty, 12); break;
                default: maxTable = 5;
            }
            
            const a = Math.floor(Math.random() * maxTable) + 1;
            const b = Math.floor(Math.random() * 10) + 1;
            const result = a * b;
            
            gameState.currentQuestion = { result: result };

            document.getElementById('gameContent').innerHTML = `
                <div class="question">${a} √ó ${b} = ?</div>
                ${classLevel <= 4 ? generateMultiplicationVisual(a, b) : ''}
                <div class="answers-grid">
                    ${generateNumberOptions(result, 4).map(num => 
                        `<button class="answer-btn" onclick="selectAnswer(${num})">${num}</button>`
                    ).join('')}
                </div>
            `;
        }

        function generateMultiplicationVisual(a, b) {
            return `
                <div class="addition-groups">
                    ${Array(b).fill(0).map((_, groupIndex) => `
                        <div class="addition-group">
                            <div class="group-label">Gruppo ${groupIndex + 1}</div>
                            <div class="objects-container">
                                ${Array(a).fill(0).map((_, i) => `
                                    <div class="visual-object" style="background: #F59E0B;">${i + 1}</div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // RIVOLUZIONATA: Sequence Game con istruzioni chiare per bambini italiani
        function generateSequenceQuestion() {
            // Scegli una routine casuale
            const routines = contentGenerators.dailyRoutines;
            const selectedRoutine = routines[Math.floor(Math.random() * routines.length)];
            
            // Mescola l'ordine per renderlo una sfida
            const correctOrder = selectedRoutine.sequence.map((item, index) => ({ ...item, correctIndex: index }));
            const shuffledOrder = [...correctOrder].sort(() => Math.random() - 0.5);
            
            gameState.currentQuestion = {
                routine: selectedRoutine,
                correct: correctOrder,
                shuffled: shuffledOrder,
                userOrder: []
            };

            document.getElementById('gameContent').innerHTML = `
                <div class="sequence-instructions">
                    <h3>üìã Come funziona:</h3>
                    <p>Devi mettere in ordine le azioni per <strong>"${selectedRoutine.name}"</strong></p>
                    <p>Clicca le azioni nel giusto ordine (da 1 a ${selectedRoutine.sequence.length})</p>
                </div>
                
                <div class="question">Metti in ordine: ${selectedRoutine.name}</div>
                
                <div class="sequence-story">
                    <strong>Cosa devi fare:</strong> Riordina queste azioni nella sequenza corretta!
                </div>
                
                <div class="sequence-options">
                    ${shuffledOrder.map((item, index) => 
                        `<div class="sequence-option" onclick="selectSequenceItem(${item.correctIndex}, '${item.text}', this)">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${item.emoji}</div>
                            <div>${item.text}</div>
                        </div>`
                    ).join('')}
                </div>
                
                <div style="margin-top: 2rem;">
                    <div style="font-weight: bold; font-size: 1.2rem; color: #374151;">La tua sequenza:</div>
                    <div id="selectedSequence" style="font-size: 1.5rem; margin-top: 1rem; min-height: 2rem; background: #F3F4F6; padding: 1rem; border-radius: 0.5rem;">
                        <em>Inizia cliccando la prima azione...</em>
                    </div>
                </div>
            `;
            
            document.getElementById('checkAnswerBtn').style.display = 'inline-block';
        }

        function selectSequenceItem(correctIndex, text, element) {
            if (element.classList.contains('selected')) return;
            
            element.classList.add('selected');
            const userOrderLength = gameState.currentQuestion.userOrder.length + 1;
            element.innerHTML += `<div class="sequence-number">${userOrderLength}</div>`;
            
            gameState.currentQuestion.userOrder.push({ correctIndex, text });
            
            // Aggiorna la visualizzazione della sequenza
            const sequenceDisplay = gameState.currentQuestion.userOrder
                .map((item, index) => `${index + 1}. ${item.text}`)
                .join('<br>');
            
            document.getElementById('selectedSequence').innerHTML = sequenceDisplay || '<em>Inizia cliccando la prima azione...</em>';
        }

        // MIGLIORATA: Pattern Game con contenuti dinamici infiniti
        function generatePatternQuestion() {
            const classLevel = currentClass;
            let patternTypes, patternLength;
            
            if (classLevel <= 2) {
                patternTypes = [contentGenerators.colors.slice(0, 3), contentGenerators.shapes.slice(0, 3), contentGenerators.fruits.slice(0, 3)];
                patternLength = 2;
            } else if (classLevel <= 3) {
                patternTypes = [contentGenerators.colors, contentGenerators.shapes, contentGenerators.animals.slice(0, 4)];
                patternLength = 3;
            } else {
                patternTypes = [contentGenerators.colors, contentGenerators.shapes, contentGenerators.animals, contentGenerators.objects];
                patternLength = Math.min(3 + adaptiveData.currentDifficulty, 5);
            }
            
            // Scegli tipo casuale e crea pattern
            const selectedType = patternTypes[Math.floor(Math.random() * patternTypes.length)];
            const patternBase = getRandomElements(selectedType, patternLength);
            
            // Estendi il pattern basato sulla difficolt√†
            const repetitions = 2 + adaptiveData.currentDifficulty;
            let fullPattern = [];
            for (let i = 0; i < repetitions; i++) {
                fullPattern = fullPattern.concat(patternBase);
            }
            
            // Rimuovi l'ultimo elemento (da indovinare)
            const correctAnswer = fullPattern.pop();
            
            gameState.currentQuestion = {
                pattern: fullPattern,
                correct: correctAnswer
            };

            // Genera opzioni casuali che includano la risposta corretta
            const wrongOptions = selectedType.filter(item => item !== correctAnswer);
            const allOptions = [correctAnswer, ...getRandomElements(wrongOptions, 3)];
            const shuffledOptions = allOptions.sort(() => Math.random() - 0.5);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Quale elemento completa il pattern?</div>
                <div class="pattern-container">
                    ${fullPattern.map(item => 
                        `<div class="pattern-item">${item}</div>`
                    ).join('')}
                    <div class="pattern-item" style="border: 3px dashed #667eea; background: #F3F4F6;">?</div>
                </div>
                <div class="answers-grid">
                    ${shuffledOptions.map(option => 
                        `<button class="answer-btn" onclick="selectAnswer('${option}')">${option}</button>`
                    ).join('')}
                </div>
            `;
        }

        // Debugging Game (Classe 2+) - Dinamica
        function generateDebuggingQuestion() {
            // Crea una sequenza corretta casuale
            const routines = contentGenerators.dailyRoutines;
            const selectedRoutine = routines[Math.floor(Math.random() * routines.length)];
            const correctSequence = selectedRoutine.sequence.map(item => item.emoji);
            
            // Introduci un errore casuale
            const errorPosition = Math.floor(Math.random() * correctSequence.length);
            const wrongSequence = [...correctSequence];
            
            // Sostituisci con un elemento casuale
            const allEmojis = [...contentGenerators.animals, ...contentGenerators.fruits, ...contentGenerators.objects];
            let wrongElement;
            do {
                wrongElement = allEmojis[Math.floor(Math.random() * allEmojis.length)];
            } while (correctSequence.includes(wrongElement));
            
            wrongSequence[errorPosition] = wrongElement;
            
            gameState.currentQuestion = { error: errorPosition };

            document.getElementById('gameContent').innerHTML = `
                <div class="question">üêõ Trova l'errore nella sequenza "${selectedRoutine.name}"!</div>
                <div class="sequence-story">
                    <strong>Sequenza corretta:</strong> ${correctSequence.join(' ‚Üí ')}<br>
                    <strong>Sequenza con errore:</strong> ${wrongSequence.join(' ‚Üí ')}
                </div>
                <div class="pattern-container">
                    ${wrongSequence.map((item, index) => 
                        `<div class="pattern-item" onclick="selectAnswer(${index})">${item}</div>`
                    ).join('')}
                </div>
                <p>Clicca sull'elemento che NON dovrebbe essere l√¨!</p>
            `;
        }

        // Loop Game (Classe 3+) - Dinamica
        function generateLoopQuestion() {
            const actions = [
                { action: 'salta', emoji: 'ü¶ò' },
                { action: 'gira', emoji: 'üåÄ' },
                { action: 'cammina', emoji: 'üö∂' },
                { action: 'batti le mani', emoji: 'üëè' },
                { action: 'alza le braccia', emoji: 'üôå' }
            ];
            
            const selectedAction = actions[Math.floor(Math.random() * actions.length)];
            const times = Math.floor(Math.random() * 8) + 2; // Da 2 a 10
            
            gameState.currentQuestion = { result: times };

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Algoritmo: Ripeti "${selectedAction.action}" ${times} volte</div>
                <div style="font-size: 4rem; margin: 2rem 0;">${selectedAction.emoji}</div>
                <div style="font-size: 1.2rem; margin: 1rem 0; background: #E3F2FD; padding: 1rem; border-radius: 0.5rem;">
                    <strong>üîÑ Loop:</strong> Per ripetere "${selectedAction.action}" ${times} volte, 
                    quante volte devo eseguire l'azione?
                </div>
                <div class="answers-grid">
                    ${generateNumberOptions(times, 4).map(num => 
                        `<button class="answer-btn" onclick="selectAnswer(${num})">${num}</button>`
                    ).join('')}
                </div>
            `;
        }

        // Conditional Game (Classe 3+) - Dinamica
        function generateConditionalQuestion() {
            const conditions = [
                { 
                    condition: 'piove', 
                    emoji: 'üåßÔ∏è',
                    actions: ['prendi l\'ombrello', 'metti l\'impermeabile', 'resta in casa'], 
                    correct: 'prendi l\'ombrello' 
                },
                { 
                    condition: 'c\'√® il sole', 
                    emoji: '‚òÄÔ∏è',
                    actions: ['metti gli occhiali da sole', 'prendi l\'ombrello', 'metti il cappotto'], 
                    correct: 'metti gli occhiali da sole' 
                },
                { 
                    condition: 'hai fame', 
                    emoji: 'üòã',
                    actions: ['mangia qualcosa', 'vai a dormire', 'studia'], 
                    correct: 'mangia qualcosa' 
                },
                { 
                    condition: 'sei stanco', 
                    emoji: 'üò¥',
                    actions: ['riposati', 'corri', 'studia'], 
                    correct: 'riposati' 
                },
                { 
                    condition: '√® freddo', 
                    emoji: 'ü•∂',
                    actions: ['metti il cappotto', 'metti i sandali', 'togli la maglietta'], 
                    correct: 'metti il cappotto' 
                }
            ];
            
            const selected = conditions[Math.floor(Math.random() * conditions.length)];
            gameState.currentQuestion = { correct: selected.correct };

            const shuffledActions = selected.actions.sort(() => Math.random() - 0.5);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">ü§î SE ${selected.condition} ${selected.emoji}, ALLORA che cosa fai?</div>
                <div style="background: #FFF9C4; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>Regola IF-THEN:</strong><br>
                    SE (condizione) ALLORA (azione logica)
                </div>
                <div class="answers-grid">
                    ${shuffledActions.map(action => 
                        `<button class="answer-btn" onclick="selectAnswer('${action}')">${action}</button>`
                    ).join('')}
                </div>
            `;
        }

        // CORRETTA: Fraction Game con visualizzazione completa delle pizza slices
        function generateFractionQuestion() {
            const denominators = currentClass >= 5 ? [2, 3, 4, 6, 8] : [2, 3, 4, 6];
            const denominator = denominators[Math.floor(Math.random() * denominators.length)];
            const numerator = Math.floor(Math.random() * denominator) + 1;
            
            // Scegli tipo di visualizzazione casuale
            const fractionTypes = ['pizza', 'chocolate', 'cake'];
            currentFractionType = fractionTypes[Math.floor(Math.random() * fractionTypes.length)];
            
            gameState.currentQuestion = {
                numerator: numerator,
                denominator: denominator,
                type: currentFractionType
            };

            let visualizationHTML = '';
            
            if (currentFractionType === 'pizza') {
                visualizationHTML = generatePizzaVisualization(denominator);
            } else if (currentFractionType === 'chocolate') {
                visualizationHTML = generateChocolateVisualization(denominator);
            } else {
                visualizationHTML = generateCakeVisualization(denominator);
            }

            document.getElementById('gameContent').innerHTML = `
                <div class="question">Seleziona ${numerator}/${denominator} ${getFractionTypeText(currentFractionType)}!</div>
                
                <div class="fraction-visual">
                    <div class="fraction-selector">
                        <div class="fraction-type ${currentFractionType === 'pizza' ? 'active' : ''}" onclick="changeFractionType('pizza')">
                            üçï Pizza
                        </div>
                        <div class="fraction-type ${currentFractionType === 'chocolate' ? 'active' : ''}" onclick="changeFractionType('chocolate')">
                            üç´ Cioccolato
                        </div>
                        <div class="fraction-type ${currentFractionType === 'cake' ? 'active' : ''}" onclick="changeFractionType('cake')">
                            üéÇ Torta
                        </div>
                    </div>
                    
                    <div class="fraction-display">
                        ${visualizationHTML}
                    </div>
                    
                    <div class="fraction-info">
                        <div style="font-size: 1.5rem; margin-bottom: 1rem;">
                            <strong>Frazione target: ${numerator}/${denominator}</strong>
                        </div>
                        <div class="fraction-stats">
                            <div class="fraction-stat">
                                <div class="fraction-stat-number" id="selectedPieces">0</div>
                                <div class="fraction-stat-label">Selezionate</div>
                            </div>
                            <div class="fraction-stat">
                                <div class="fraction-stat-number">${denominator}</div>
                                <div class="fraction-stat-label">Totali</div>
                            </div>
                            <div class="fraction-stat">
                                <div class="fraction-stat-number" id="currentFraction">0/${denominator}</div>
                                <div class="fraction-stat-label">Frazione attuale</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            setupFractionInteractions();
            document.getElementById('checkAnswerBtn').style.display = 'inline-block';
        }

        function getFractionTypeText(type) {
            switch(type) {
                case 'pizza': return 'della pizza';
                case 'chocolate': return 'del cioccolato';
                case 'cake': return 'della torta';
                default: return 'dell\'oggetto';
            }
        }

        function generatePizzaVisualization(denominator) {
            return `
                <div class="pizza-container" id="fractionContainer">
                    ${Array(denominator).fill(0).map((_, i) => 
                        `<div class="pizza-slice" data-piece="${i}" onclick="toggleFractionPiece(this)"></div>`
                    ).join('')}
                </div>
            `;
        }

        function generateChocolateVisualization(denominator) {
            const rows = Math.ceil(Math.sqrt(denominator));
            const cols = Math.ceil(denominator / rows);
            
            return `
                <div class="chocolate-container" id="fractionContainer" style="grid-template-columns: repeat(${cols}, 50px); grid-template-rows: repeat(${rows}, 40px);">
                    ${Array(denominator).fill(0).map((_, i) => 
                        `<div class="chocolate-piece" data-piece="${i}" onclick="toggleFractionPiece(this)">${i + 1}</div>`
                    ).join('')}
                </div>
            `;
        }

        function generateCakeVisualization(denominator) {
            return `
                <div class="cake-container" id="fractionContainer">
                    ${Array(denominator).fill(0).map((_, i) => 
                        `<div class="cake-slice" data-piece="${i}" onclick="toggleFractionPiece(this)" 
                             style="left: ${(i * 200 / denominator)}px; width: ${200 / denominator}px;">${i + 1}</div>`
                    ).join('')}
                </div>
            `;
        }

        function setupFractionInteractions() {
            // Setup pizza slices positioning - CORRETTA
            if (currentFractionType === 'pizza') {
                const slices = document.querySelectorAll('.pizza-slice');
                const denominator = gameState.currentQuestion.denominator;
                slices.forEach((slice, index) => {
                    const angle = (360 / denominator) * index;
                    const nextAngle = (360 / denominator) * (index + 1);
                    
                    // Calcola i punti per creare le fette triangolari
                    const centerX = 50;
                    const centerY = 50;
                    const radius = 47; // Leggermente pi√π piccolo del contenitore
                    
                    const startAngle = (angle - 90) * Math.PI / 180; // -90 per iniziare dall'alto
                    const endAngle = (nextAngle - 90) * Math.PI / 180;
                    
                    const x1 = centerX + radius * Math.cos(startAngle);
                    const y1 = centerY + radius * Math.sin(startAngle);
                    const x2 = centerX + radius * Math.cos(endAngle);
                    const y2 = centerY + radius * Math.sin(endAngle);
                    
                    // Crea il triangolo usando clip-path
                    slice.style.clipPath = `polygon(${centerX}% ${centerY}%, ${x1}% ${y1}%, ${x2}% ${y2}%)`;
                    slice.style.transform = 'none'; // Rimuovi trasformazioni precedenti
                    slice.style.top = '0';
                    slice.style.left = '0';
                    slice.style.width = '100%';
                    slice.style.height = '100%';
                });
            }
        }

        function changeFractionType(newType) {
            currentFractionType = newType;
            gameState.currentQuestion.type = newType;
            
            // Regenera la visualizzazione
            let visualizationHTML = '';
            if (newType === 'pizza') {
                visualizationHTML = generatePizzaVisualization(gameState.currentQuestion.denominator);
            } else if (newType === 'chocolate') {
                visualizationHTML = generateChocolateVisualization(gameState.currentQuestion.denominator);
            } else {
                visualizationHTML = generateCakeVisualization(gameState.currentQuestion.denominator);
            }
            
            document.querySelector('.fraction-display').innerHTML = visualizationHTML;
            
            // Aggiorna i selettori attivi
            document.querySelectorAll('.fraction-type').forEach(el => el.classList.remove('active'));
            document.querySelector(`.fraction-type:nth-child(${['pizza', 'chocolate', 'cake'].indexOf(newType) + 1})`).classList.add('active');
            
            // Reset selezioni
            document.getElementById('selectedPieces').textContent = '0';
            document.getElementById('currentFraction').textContent = `0/${gameState.currentQuestion.denominator}`;
            
            setupFractionInteractions();
        }

        function toggleFractionPiece(piece) {
            piece.classList.toggle('filled');
            const selectedCount = document.querySelectorAll(`#fractionContainer .${currentFractionType === 'pizza' ? 'pizza-slice' : currentFractionType === 'chocolate' ? 'chocolate-piece' : 'cake-slice'}.filled`).length;
            
            document.getElementById('selectedPieces').textContent = selectedCount;
            document.getElementById('currentFraction').textContent = `${selectedCount}/${gameState.currentQuestion.denominator}`;
        }

        // RIVOLUZIONATA: Variable Game con scenari interessanti
        function generateVariableQuestion() {
            const scenarios = contentGenerators.variableScenarios;
            const selectedScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            const selectedVariable = selectedScenario.variables[Math.floor(Math.random() * selectedScenario.variables.length)];
            
            const value = Math.floor(Math.random() * (selectedVariable.max - selectedVariable.min + 1)) + selectedVariable.min;
            
            // Crea operazioni con la variabile
            const operations = [
                { 
                    question: `Nel ${selectedScenario.context}, la variabile "${selectedVariable.name}" contiene ${selectedVariable.description}. Se "${selectedVariable.name}" = ${value}, quanto vale ${selectedVariable.name} + 5?`,
                    result: value + 5
                },
                { 
                    question: `Nel ${selectedScenario.context}, se la variabile "${selectedVariable.name}" (${selectedVariable.description}) vale ${value}, quanto vale ${selectedVariable.name} - 3?`,
                    result: Math.max(0, value - 3)
                },
                { 
                    question: `Nel ${selectedScenario.context}, la variabile "${selectedVariable.name}" rappresenta ${selectedVariable.description}. Se "${selectedVariable.name}" = ${value}, qual √® il valore di "${selectedVariable.name}"?`,
                    result: value
                }
            ];
            
            const selectedOperation = operations[Math.floor(Math.random() * operations.length)];
            gameState.currentQuestion = { result: selectedOperation.result };

            document.getElementById('gameContent').innerHTML = `
                <div class="question">${selectedOperation.question}</div>
                <div style="background: #E8F5E8; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>üì¶ Ricorda:</strong> Una variabile √® come una scatola con un nome che contiene un valore!
                </div>
                <div class="answers-grid">
                    ${generateNumberOptions(selectedOperation.result, 4).map(num => 
                        `<button class="answer-btn" onclick="selectAnswer(${num})">${num}</button>`
                    ).join('')}
                </div>
            `;
        }

        // RIVOLUZIONATA: Algorithm Game con sfide realistiche
        function generateAlgorithmQuestion() {
            const challenges = contentGenerators.algorithmChallenges;
            const selectedType = challenges[Math.floor(Math.random() * challenges.length)];
            const selectedScenario = selectedType.scenarios[Math.floor(Math.random() * selectedType.scenarios.length)];
            
            let question, options, correct;
            
            if (selectedType.type === 'ordinamento') {
                const strategies = [
                    'Confrontare ogni elemento con il successivo',
                    'Trovare prima il pi√π piccolo, poi il secondo pi√π piccolo...',
                    'Dividere in gruppi pi√π piccoli e ordinare',
                    'Usare le dita per tenere traccia'
                ];
                
                correct = strategies[Math.floor(Math.random() * 2)]; // Prime due sono pi√π corrette
                options = [correct, ...getRandomElements(strategies.filter(s => s !== correct), 3)];
                
                question = `${selectedScenario.task}. Quale strategia √® pi√π efficace?`;
            } else {
                const strategies = [
                    selectedScenario.strategy,
                    'Guardare a caso',
                    'Chiedere a tutti',
                    'Aspettare che arrivi da solo'
                ];
                
                correct = selectedScenario.strategy;
                options = strategies;
                question = `${selectedScenario.task}. Quale strategia usi?`;
            }
            
            gameState.currentQuestion = { correct: correct };
            const shuffledOptions = options.sort(() => Math.random() - 0.5);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">${question}</div>
                <div style="background: #F0F8F0; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>üß† Algoritmo:</strong> Una sequenza di passi logici per risolvere un problema!
                </div>
                <div class="sequence-options">
                    ${shuffledOptions.map(option => 
                        `<div class="sequence-option" onclick="selectAnswer('${option}')">
                            ${option}
                        </div>`
                    ).join('')}
                </div>
            `;
        }

        // Statistics Game (Classe 5) - Dinamica
        function generateStatisticsQuestion() {
            const dataSize = Math.min(5 + adaptiveData.currentDifficulty, 8);
            const data = Array.from({length: dataSize}, () => Math.floor(Math.random() * 20) + 1);
            
            const operations = [
                {
                    type: 'media',
                    question: `Calcola la media dei voti: ${data.join(', ')}`,
                    result: Math.round(data.reduce((a, b) => a + b, 0) / data.length)
                },
                {
                    type: 'massimo',
                    question: `Trova il numero pi√π grande: ${data.join(', ')}`,
                    result: Math.max(...data)
                },
                {
                    type: 'minimo',
                    question: `Trova il numero pi√π piccolo: ${data.join(', ')}`,
                    result: Math.min(...data)
                },
                {
                    type: 'somma',
                    question: `Calcola la somma totale: ${data.join(', ')}`,
                    result: data.reduce((a, b) => a + b, 0)
                }
            ];
            
            const selectedOperation = operations[Math.floor(Math.random() * operations.length)];
            gameState.currentQuestion = { result: selectedOperation.result };

            document.getElementById('gameContent').innerHTML = `
                <div class="question">${selectedOperation.question}</div>
                <div style="background: #E8F5F9; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>üìä Statistica:</strong> Analizziamo i dati per trovare informazioni utili!
                    <br><strong>Tipo:</strong> ${selectedOperation.type.toUpperCase()}
                </div>
                <div style="background: #F5F5F5; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; font-family: monospace; font-size: 1.3rem;">
                    Dati: [${data.join(', ')}]
                </div>
                <div class="answers-grid">
                    ${generateNumberOptions(selectedOperation.result, 4).map(num => 
                        `<button class="answer-btn" onclick="selectAnswer(${num})">${num}</button>`
                    ).join('')}
                </div>
            `;
        }

        // RIVOLUZIONATA: Project Game con scenari realistici
        function generateProjectQuestion() {
            const projects = [
                { 
                    project: 'Un gioco di memoria',
                    components: ['pulsanti colorati', 'suoni', 'timer', 'grafica'],
                    correct: 'pulsanti colorati',
                    explanation: 'I pulsanti sono essenziali per l\'interazione!'
                },
                { 
                    project: 'Un calcolatore',
                    components: ['numeri e operatori', 'colori', 'musica', 'animazioni'],
                    correct: 'numeri e operatori',
                    explanation: 'Senza numeri non puoi fare calcoli!'
                },
                { 
                    project: 'Un quiz educativo',
                    components: ['domande e risposte', 'effetti speciali', 'mascotte', 'sfondi'],
                    correct: 'domande e risposte',
                    explanation: 'Le domande sono il cuore del quiz!'
                },
                {
                    project: 'Un\'app per disegnare',
                    components: ['strumenti di disegno', 'chat', 'calendario', 'meteo'],
                    correct: 'strumenti di disegno',
                    explanation: 'Servono pennelli, colori e canvas!'
                }
            ];
            
            const selected = projects[Math.floor(Math.random() * projects.length)];
            gameState.currentQuestion = { 
                correct: selected.correct,
                explanation: selected.explanation
            };

            const shuffledComponents = selected.components.sort(() => Math.random() - 0.5);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">üéÆ Per creare "${selected.project}", quale componente √® pi√π importante?</div>
                <div style="background: #FFF3E0; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>üí° Progettazione:</strong> Ogni progetto ha componenti essenziali e opzionali.
                    <br>Pensa a cosa serve DAVVERO per far funzionare il progetto!
                </div>
                <div class="sequence-options">
                    ${shuffledComponents.map(component => 
                        `<div class="sequence-option" onclick="selectAnswer('${component}')">
                            ${component}
                        </div>`
                    ).join('')}
                </div>
            `;
        }

        // MIGLIORATA: Collaboration Game con scenari reali
        function generateCollaborationQuestion() {
            const scenarios = [
                { 
                    scenario: 'Stai lavorando in team su un progetto di coding e devi condividere il tuo codice',
                    tools: ['repository condiviso (Git)', 'email', 'telefono', 'biglietti'],
                    correct: 'repository condiviso (Git)',
                    explanation: 'Git permette di collaborare sul codice in sicurezza!'
                },
                { 
                    scenario: 'Il tuo compagno ha fatto delle modifiche al progetto e vuoi vedere cosa ha cambiato',
                    tools: ['sistema di controllo versioni', 'indovinare', 'chiedere agli altri', 'rifare tutto'],
                    correct: 'sistema di controllo versioni',
                    explanation: 'Permette di vedere tutte le modifiche!'
                },
                { 
                    scenario: 'Vuoi lasciare un commento sul lavoro del tuo gruppo per dare un suggerimento',
                    tools: ['sistema di commenti', 'messaggi privati', 'ignorare', 'cancellare tutto'],
                    correct: 'sistema di commenti',
                    explanation: 'I commenti aiutano il team a migliorare!'
                },
                {
                    scenario: 'Due persone del team hanno modificato la stessa parte del codice contemporaneamente',
                    tools: ['sistema di merge e conflitti', 'scegliere a caso', 'litigare', 'ricominciare'],
                    correct: 'sistema di merge e conflitti',
                    explanation: 'I sistemi moderni aiutano a risolvere i conflitti!'
                }
            ];
            
            const selected = scenarios[Math.floor(Math.random() * scenarios.length)];
            gameState.currentQuestion = { 
                correct: selected.correct,
                explanation: selected.explanation
            };

            const shuffledTools = selected.tools.sort(() => Math.random() - 0.5);

            document.getElementById('gameContent').innerHTML = `
                <div class="question">ü§ù ${selected.scenario}. Quale strumento usi?</div>
                <div style="background: #E8F5E8; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>üë• Collaborazione:</strong> Nel mondo del coding si lavora spesso in team.
                    <br>Gli strumenti giusti rendono tutto pi√π facile!
                </div>
                <div class="sequence-options">
                    ${shuffledTools.map(tool => 
                        `<div class="sequence-option" onclick="selectAnswer('${tool}')">
                            ${tool}
                        </div>`
                    ).join('')}
                </div>
            `;
        }

        // Answer selection
        function selectAnswer(answer) {
            if (gameState.isAnswered) return;
            
            gameState.userAnswer = answer;
            gameState.isAnswered = true;
            
            // Disable all answer buttons
            document.querySelectorAll('.answer-btn, .sequence-option').forEach(btn => {
                btn.style.pointerEvents = 'none';
            });
            
            checkAnswerLogic();
        }

        // Check answer function
        function checkAnswer() {
            if (gameState.isAnswered) return;
            
            let isCorrect = false;
            
            switch (currentGame) {
                case 'sequenze-base':
                    // Verifica che l'ordine sia corretto
                    const userOrder = gameState.currentQuestion.userOrder.map(item => item.correctIndex);
                    const correctOrder = gameState.currentQuestion.correct.map((_, index) => index);
                    isCorrect = JSON.stringify(userOrder) === JSON.stringify(correctOrder);
                    break;
                case 'frazioni-visual':
                    const selectedPieces = document.querySelectorAll(`#fractionContainer .${currentFractionType === 'pizza' ? 'pizza-slice' : currentFractionType === 'chocolate' ? 'chocolate-piece' : 'cake-slice'}.filled`).length;
                    isCorrect = selectedPieces === gameState.currentQuestion.numerator;
                    break;
                default:
                    return;
            }
            
            gameState.isAnswered = true;
            processAnswer(isCorrect);
        }

        function checkAnswerLogic() {
            let isCorrect = false;
            
            switch (currentGame) {
                case 'conteggio':
                    isCorrect = gameState.userAnswer === gameState.currentQuestion.count;
                    break;
                case 'addizioni-visual':
                case 'operazioni-entro-20':
                case 'tabelline-base':
                case 'loop-semplici':
                case 'variabili-semplici':
                case 'algoritmi-avanzati':
                case 'statistica-base':
                    isCorrect = gameState.userAnswer === gameState.currentQuestion.result;
                    break;
                case 'pattern-semplici':
                case 'if-then-base':
                case 'progetti-completi':
                case 'collaborazione-digitale':
                    isCorrect = gameState.userAnswer === gameState.currentQuestion.correct;
                    break;
                case 'debugging-visuale':
                    isCorrect = gameState.userAnswer === gameState.currentQuestion.error;
                    break;
                default:
                    // For other games, assume the answer is stored in currentQuestion.correct or result
                    isCorrect = gameState.userAnswer === (gameState.currentQuestion.correct || gameState.currentQuestion.result);
            }
            
            processAnswer(isCorrect);
        }

        // Process answer and update adaptive system
        function processAnswer(isCorrect) {
            adaptiveData.totalQuestions++;
            
            if (isCorrect) {
                adaptiveData.correctAnswers++;
                adaptiveData.consecutiveCorrect++;
                adaptiveData.consecutiveWrong = 0;
                adaptiveData.hintLevel = 0;
                
                let successMessage = 'Corretto! Ottimo lavoro! üéâ';
                
                // Aggiungi spiegazione per giochi pi√π complessi
                if (gameState.currentQuestion.explanation) {
                    successMessage += `<br><br>üí° ${gameState.currentQuestion.explanation}`;
                }
                
                showMessage(successMessage, 'success');
                
                // Update score based on difficulty and class level
                const pointsEarned = 10 * adaptiveData.currentDifficulty * currentClass;
                score += pointsEarned;
                stars += adaptiveData.currentDifficulty;
                
                // Increase difficulty if performing well
                if (adaptiveData.consecutiveCorrect >= 3 && 
                    adaptiveData.currentDifficulty < adaptiveData.maxDifficulty) {
                    adaptiveData.currentDifficulty++;
                    level = adaptiveData.currentDifficulty;
                    adaptiveData.consecutiveCorrect = 0;
                    showMessage('Livello aumentato! Sei diventato pi√π bravo! ‚≠ê', 'success');
                }
                
                // Highlight correct answer
                document.querySelectorAll('.answer-btn, .sequence-option').forEach(btn => {
                    const btnText = btn.textContent.trim();
                    const userAnswerText = String(gameState.userAnswer).trim();
                    if (btnText === userAnswerText || btnText.includes(userAnswerText)) {
                        btn.classList.add('correct');
                    }
                });
                
            } else {
                adaptiveData.consecutiveWrong++;
                adaptiveData.consecutiveCorrect = 0;
                adaptiveData.hintLevel++;
                
                let errorMessage = 'Non √® corretto. Riprova! üí™';
                
                // Aggiungi spiegazione per giochi pi√π complessi
                if (gameState.currentQuestion.explanation) {
                    errorMessage += `<br><br>üí° Suggerimento: ${gameState.currentQuestion.explanation}`;
                }
                
                showMessage(errorMessage, 'error');
                
                // Decrease difficulty if struggling
                if (adaptiveData.consecutiveWrong >= 3 && adaptiveData.currentDifficulty > 1) {
                    adaptiveData.currentDifficulty--;
                    level = adaptiveData.currentDifficulty;
                    adaptiveData.consecutiveWrong = 0;
                    showMessage('Ho reso il gioco un po\' pi√π semplice per te! üåü', 'hint');
                }
                
                // Show hint after multiple wrong answers
                if (adaptiveData.hintLevel >= 2) {
                    showHint();
                }
                
                // Highlight wrong answer
                document.querySelectorAll('.answer-btn, .sequence-option').forEach(btn => {
                    const btnText = btn.textContent.trim();
                    const userAnswerText = String(gameState.userAnswer).trim();
                    if (btnText === userAnswerText || btnText.includes(userAnswerText)) {
                        btn.classList.add('wrong');
                    }
                });
            }
            
            saveAdaptiveData();
            saveProgress();
        }

        // MIGLIORATO: Hint system con consigli specifici
        function showHint() {
            const hints = {
                'conteggio': 'Conta lentamente ogni oggetto, uno alla volta. Usa le dita se ti aiuta! Puoi anche raggrupparli per 5.',
                'addizioni-visual': 'Conta prima tutti gli oggetti del primo gruppo, poi quelli del secondo gruppo, infine sommali insieme!',
                'operazioni-entro-20': 'Per le sottrazioni, parti dal numero pi√π grande e togli quello pi√π piccolo! Per le addizioni, inizia dal numero pi√π grande e aggiungi.',
                'pattern-semplici': 'Guarda attentamente: quale elemento si ripete? Osserva la sequenza dall\'inizio e trova il ritmo!',
                'sequenze-base': 'Pensa passo dopo passo: cosa fai per PRIMO, poi cosa viene DOPO? Segui l\'ordine logico delle azioni!',
                'debugging-visuale': 'Confronta con quello che dovrebbe essere giusto. Quale elemento √® diverso o fuori posto?',
                'tabelline-base': 'Ricorda: moltiplicare significa sommare tante volte lo stesso numero! 3√ó4 = 3+3+3+3',
                'loop-semplici': 'Un loop ripete un\'azione. Se devi fare qualcosa 5 volte, il loop esegue l\'azione esattamente 5 volte!',
                'if-then-base': 'Se succede una cosa, allora devi fare un\'azione logica. Cosa faresti davvero in quella situazione?',
                'frazioni-visual': 'Una frazione ti dice quante parti colorare del totale. Se √® 2/4, colora 2 parti su 4! Puoi cambiare tipo di visualizzazione cliccando i pulsanti sopra.',
                'variabili-semplici': 'Una variabile √® come una scatola con un\'etichetta. Leggi bene la domanda: cosa chiede esattamente?',
                'algoritmi-avanzati': 'Pensa alla strategia pi√π efficace e logica. Quale approccio risolverebbe davvero il problema?',
                'statistica-base': 'Media = somma tutti i numeri √∑ quanti sono. Massimo = il pi√π grande. Minimo = il pi√π piccolo.',
                'progetti-completi': 'Pensa a cosa √® INDISPENSABILE per far funzionare quel tipo di progetto. Senza quale componente non funzionerebbe?',
                'collaborazione-digitale': 'Nel coding moderno si usano strumenti specifici. Quale strumento risolve davvero quel problema nel team?',
                'default': 'Leggi attentamente la domanda e pensa con calma. Ogni indizio √® importante! Puoi farcela!'
            };
            
            const hintText = hints[currentGame] || hints['default'];
            document.getElementById('hintText').innerHTML = hintText;
            document.getElementById('hintContainer').style.display = 'flex';
        }

        function hideHint() {
            document.getElementById('hintContainer').style.display = 'none';
        }

        // Utility functions
        function generateNumberOptions(correct, count) {
            const options = [correct];
            const min = Math.max(1, correct - 5);
            const max = correct + 5;
            
            while (options.length < count) {
                const random = Math.floor(Math.random() * (max - min + 1)) + min;
                if (!options.includes(random) && random > 0) {
                    options.push(random);
                }
            }
            
            return options.sort(() => Math.random() - 0.5);
        }

        // Progress saving
        function saveProgress() {
            localStorage.setItem('edutech_score', score.toString());
            localStorage.setItem('edutech_stars', stars.toString());
            localStorage.setItem('edutech_level', level.toString());
            updateStatsDisplay();
        }

        // Reset progress
        function resetProgress() {
            if (confirm('Sei sicuro di voler resettare tutti i progressi? (Utile per cambio classe)')) {
                score = 0;
                stars = 0;
                level = 1;
                adaptiveData = {
                    consecutiveCorrect: 0,
                    consecutiveWrong: 0,
                    totalQuestions: 0,
                    correctAnswers: 0,
                    currentDifficulty: 1,
                    maxDifficulty: 5,
                    hintLevel: 0
                };
                
                localStorage.removeItem('edutech_score');
                localStorage.removeItem('edutech_stars');
                localStorage.removeItem('edutech_level');
                localStorage.removeItem('edutech_adaptive');
                
                updateStatsDisplay();
                document.getElementById('stats-bar').style.display = 'none';
            }
        }

        // Message system
        function showMessage(text, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = text; // Cambiato da textContent a innerHTML per supportare HTML
            container.className = `message ${type} show`;
            
            setTimeout(() => {
                hideMessage();
            }, 5000); // Aumentato tempo per messaggi pi√π lunghi
        }

        function hideMessage() {
            const container = document.getElementById('messageContainer');
            container.classList.remove('show');
        }

        // Navigation functions
        function backToHome() {
            document.getElementById('gamesSection').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'none';
            document.getElementById('homepage').style.display = 'block';
            exitFullscreen();
        }

        function backToGames() {
            document.getElementById('gameInterface').style.display = 'none';
            document.getElementById('gamesSection').style.display = 'block';
            exitFullscreen();
        }

        function nextQuestion() {
            generateQuestion();
        }

        // Fullscreen functionality
        function toggleFullscreen() {
            const gameInterface = document.getElementById('gameInterface');
            
            if (!document.fullscreenElement) {
                gameInterface.requestFullscreen().then(() => {
                    gameInterface.classList.add('fullscreen-mode');
                }).catch(err => {
                    console.log('Errore fullscreen:', err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    gameInterface.classList.remove('fullscreen-mode');
                });
            }
        }

        function exitFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen().then(() => {
                    document.getElementById('gameInterface').classList.remove('fullscreen-mode');
                });
            }
        }

        // Handle fullscreen change
        document.addEventListener('fullscreenchange', () => {
            const gameInterface = document.getElementById('gameInterface');
            if (!document.fullscreenElement) {
                gameInterface.classList.remove('fullscreen-mode');
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadAdaptiveData();
            
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker registration failed:', error);
                    });
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.fullscreenElement) {
                    exitFullscreen();
                } else if (document.getElementById('gameInterface').style.display === 'block') {
                    backToGames();
                } else if (document.getElementById('gamesSection').style.display === 'block') {
                    backToHome();
                }
            }
            
            if (e.key === 'Enter' && !gameState.isAnswered) {
                if (document.getElementById('checkAnswerBtn').style.display !== 'none') {
                    checkAnswer();
                }
            }
            
            // Number keys for quick answer selection
            if (e.key >= '1' && e.key <= '4' && !gameState.isAnswered) {
                const answerBtns = document.querySelectorAll('.answer-btn');
                const index = parseInt(e.key) - 1;
                if (answerBtns[index]) {
                    answerBtns[index].click();
                }
            }
        });
    </script>
</body>
</html>
