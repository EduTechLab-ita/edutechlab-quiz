<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTechLab - Pensiero Computazionale</title>
    <meta name="description" content="Piattaforma di Pensiero Computazionale per la Scuola Primaria">
    <meta name="theme-color" content="#3B82F6">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="EduTech Quiz">
    
    <meta name="msapplication-TileImage" content="icon-192.png">
    <meta name="msapplication-TileColor" content="#3B82F6">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1a1a1a;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* STILE BANNER AGGIORNAMENTO CORRETTO */
        #update-banner {
            position: fixed;
            top: 20px; /* Spostato in alto */
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #update-banner.banner-nascosto {
            display: none;
        }
        #update-banner button {
            padding: 8px 12px;
            border: 1px solid white;
            background-color: transparent;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        #update-banner button:hover {
            background-color: white;
            color: #4CAF50;
        }
        
        /* ... il resto del tuo CSS ... */
        .main-container{min-height:100vh;position:relative}.animated-bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}.floating-shape{position:absolute;border-radius:50%;background:rgba(255,255,255,.1);animation:float 6s ease-in-out infinite}.floating-shape:nth-child(1){top:20%;left:10%;width:80px;height:80px;animation-delay:0s}.floating-shape:nth-child(2){top:40%;left:80%;width:60px;height:60px;animation-delay:2s}.floating-shape:nth-child(3){top:70%;left:20%;width:100px;height:100px;animation-delay:4s}.floating-shape:nth-child(4){top:80%;left:60%;width:40px;height:40px;animation-delay:1s}@keyframes float{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-20px) rotate(180deg)}}.header{text-align:center;padding:2rem;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);margin:1rem;border-radius:2rem;box-shadow:0 8px 32px rgba(0,0,0,.1)}.header h1{font-size:3rem;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:.5rem}.header h2{font-size:1.5rem;color:#374151;margin-bottom:.5rem}.header p{color:#6b7280;font-size:1.1rem}.stats-bar{display:flex;justify-content:center;gap:1rem;margin:1rem;flex-wrap:wrap}.stat-item{background:rgba(255,255,255,.9);padding:.75rem 1.5rem;border-radius:50px;font-weight:700;font-size:1.1rem;box-shadow:0 2px 8px rgba(0,0,0,.1);backdrop-filter:blur(10px)}.stat-stars{background:#fef3c7;color:#92400e}.stat-score{background:#d1fae5;color:#065f46}.stat-level{background:#e0e7ff;color:#3730a3}.classes-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;padding:1rem;max-width:1200px;margin:0 auto}.class-card{background:rgba(255,255,255,.95);border-radius:1.5rem;padding:2rem;cursor:pointer;transition:all .3s ease;box-shadow:0 8px 32px rgba(0,0,0,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);text-align:center}.class-card:hover{transform:translateY(-5px);box-shadow:0 12px 40px rgba(0,0,0,.15)}.card-emoji{font-size:4rem;margin-bottom:1rem;display:block}.card-title{font-size:1.3rem;font-weight:700;color:#1f2937;margin-bottom:.5rem}.card-description{color:#6b7280;font-size:.9rem;margin-bottom:1rem}.card-badges{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-bottom:1rem}.badge{padding:.3rem .8rem;border-radius:50px;font-size:.8rem;font-weight:500}.badge.math{background:#eff6ff;color:#1e40af}.badge.coding{background:#ecfdf5;color:#059669}.badge.thinking{background:#faf5ff;color:#7c3aed}.games-section{display:none;padding:1rem;max-width:1200px;margin:0 auto}.games-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem}.game-card{background:rgba(255,255,255,.95);border-radius:1.5rem;padding:2rem;cursor:pointer;transition:all .3s ease;box-shadow:0 8px 32px rgba(0,0,0,.1);text-align:center}.game-card:hover{transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,.15)}.nav-btn{background:rgba(255,255,255,.9);border:none;padding:.75rem 1.5rem;border-radius:50px;cursor:pointer;font-size:1rem;font-weight:600;transition:all .3s ease;display:inline-flex;align-items:center;gap:.5rem;box-shadow:0 4px 12px rgba(0,0,0,.1)}.nav-btn:hover{background:#fff;transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.15)}.reset-btn{background:#fee2e2;color:#dc2626}.reset-btn:hover{background:#fef2f2}.game-interface{display:none;background:rgba(255,255,255,.98);border-radius:2rem;margin:1rem;padding:2rem;box-shadow:0 8px 32px rgba(0,0,0,.1);backdrop-filter:blur(10px)}.game-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem}.game-controls{display:flex;gap:.5rem;flex-wrap:wrap}.btn{padding:.75rem 1.5rem;border:none;border-radius:1rem;cursor:pointer;font-weight:600;transition:all .3s ease;display:inline-flex;align-items:center;gap:.5rem;font-size:1rem}.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}.btn-secondary{background:#f0f0f0;color:#333}.btn-success{background:#4caf50;color:#fff}.btn-warning{background:#ff9800;color:#fff}.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}.fullscreen-btn{background:#2196f3;color:#fff;border:none;padding:.75rem;border-radius:50%;cursor:pointer;font-size:1.2rem;transition:all .3s ease}.fullscreen-btn:hover{background:#1976d2;transform:scale(1.1)}.fullscreen-mode{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#fff;z-index:9999;display:flex;flex-direction:column;overflow:auto}.fullscreen-header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center}.exit-fullscreen{background:rgba(255,255,255,.2);color:#fff;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer}.adaptive-stats{background:linear-gradient(135deg,#e8f5e8,#f0f8f0);border-radius:1rem;padding:1.5rem;margin-bottom:2rem;border-left:4px solid #4caf50}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}.stat-number{font-size:2rem;font-weight:700;color:#2e7d32}.stat-label{color:#555;font-size:.9rem}.hint-container{background:#fff3cd;border:1px solid #ffeaa7;border-radius:1rem;padding:1rem;margin:1rem 0;display:none;align-items:center;gap:1rem}.hint-icon{font-size:2rem;animation:pulse 1.5s infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}.difficulty-indicator{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem}.difficulty-star{font-size:1.5rem;color:#ddd;transition:color .3s ease}.difficulty-star.active{color:#ffd700}.game-content{background:#f8f9fa;border-radius:1rem;padding:2rem;margin:1rem 0;min-height:300px;display:flex;flex-direction:column;align-items:center;justify-content:center}.question{font-size:2rem;font-weight:700;text-align:center;margin-bottom:2rem;color:#333}.answers-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:1rem;width:100%;max-width:600px}.answer-btn{padding:1.5rem;font-size:1.5rem;border:2px solid #ddd;border-radius:1rem;background:#fff;cursor:pointer;transition:all .3s ease}.answer-btn:hover{border-color:#667eea;background:#f0f4ff;transform:scale(1.05)}.answer-btn.correct{background:#4caf50;color:#fff;border-color:#45a049}.answer-btn.wrong{background:#f44336;color:#fff;border-color:#d32f2f}.counting-objects{display:flex;flex-wrap:wrap;gap:.8rem;justify-content:center;align-items:center;margin:2rem 0;max-height:40vh;overflow-y:auto;padding:1rem;background:rgba(255,255,255,.5);border-radius:1rem}.visual-objects{display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;align-items:center;margin:2rem 0;max-height:45vh;overflow-y:auto;padding:1rem;background:rgba(255,255,255,.5);border-radius:1rem}.counting-object{font-size:clamp(1.5rem,3vw,2.5rem);padding:.3rem;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;width:clamp(50px,8vw,70px);height:clamp(50px,8vw,70px);display:flex;align-items:center;justify-content:center;animation:bounceIn .5s ease-out;flex-shrink:0}@keyframes bounceIn{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}.visual-object{width:clamp(40px,6vw,60px);height:clamp(40px,6vw,60px);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:clamp(.8rem,2vw,1.2rem);font-weight:700;color:#fff;transition:transform .2s;flex-shrink:0}.visual-object:hover{transform:scale(1.1)}.addition-groups{display:flex;flex-wrap:wrap;gap:2rem;justify-content:center;align-items:center;margin:2rem 0;max-height:50vh;overflow-y:auto;padding:1.5rem;background:rgba(255,255,255,.7);border-radius:1.5rem}.addition-group{display:flex;flex-direction:column;align-items:center;gap:1rem}.group-label{font-size:1.2rem;font-weight:700;color:#374151;background:rgba(255,255,255,.9);padding:.5rem 1rem;border-radius:50px}.objects-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(45px,1fr));gap:.5rem;max-width:200px}.operator{font-size:clamp(2rem,4vw,3rem);color:#667eea;font-weight:700;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.9);border-radius:50%;width:clamp(60px,8vw,80px);height:clamp(60px,8vw,80px)}.pattern-container{display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;margin:2rem 0}.pattern-item{width:80px;height:80px;border-radius:1rem;display:flex;align-items:center;justify-content:center;font-size:2.5rem;border:3px solid #ddd;cursor:pointer;transition:all .3s ease}.pattern-item.selected{border-color:#667eea;background:#f0f4ff}.pattern-item.correct{background:#4caf50;color:#fff;border-color:#45a049}.sequence-instructions{background:#e3f2fd;border:2px solid #2196f3;border-radius:1rem;padding:1.5rem;margin-bottom:2rem;text-align:center}.sequence-instructions h3{color:#1976d2;margin-bottom:.5rem}.sequence-story{background:#fff9c4;border:2px solid #fbc02d;border-radius:1rem;padding:1.5rem;margin:1rem 0;text-align:center}.sequence-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin:2rem 0;max-width:800px}.sequence-option{background:#fff;border:3px solid #e0e0e0;border-radius:1rem;padding:1rem;font-size:1.1rem;cursor:pointer;transition:all .2s;text-align:center;position:relative}.sequence-option:hover{border-color:#667eea;background:#f0f4ff;transform:translateY(-2px)}.sequence-option.selected{border-color:#4caf50;background:#e8f5e8}.sequence-number{position:absolute;top:-10px;right:-10px;background:#4caf50;color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700}.fraction-visual{display:flex;flex-direction:column;align-items:center;gap:2rem;padding:2rem;background:rgba(255,255,255,.9);border-radius:1.5rem;margin:2rem 0}.fraction-selector{display:flex;gap:2rem;margin-bottom:2rem;flex-wrap:wrap;justify-content:center}.fraction-type{background:#f0f0f0;border:2px solid #ddd;border-radius:1rem;padding:1rem;cursor:pointer;transition:all .3s ease;text-align:center;min-width:120px}.fraction-type:hover{border-color:#667eea;background:#f0f4ff}.fraction-type.active{border-color:#4caf50;background:#e8f5e8}.fraction-display{position:relative;margin:2rem 0}.pizza-container{position:relative;width:250px;height:250px;border-radius:50%;background:#fff3e0;border:4px solid #ff6b35;overflow:hidden;margin:0 auto}.pizza-slice{position:absolute;width:50%;height:50%;border:2px solid #ff6b35;cursor:pointer;transition:all .3s ease;transform-origin:100% 100%;background:#fff8dc;top:50%;left:50%}.pizza-slice:hover{background:#ffe4b5;transform:scale(1.05)}.pizza-slice.filled{background:#ff6b35;background-image:radial-gradient(circle at 30% 40%,#ff4500 8px,transparent 8px),radial-gradient(circle at 70% 30%,#dc143c 6px,transparent 6px),radial-gradient(circle at 40% 80%,#228b22 5px,transparent 5px),radial-gradient(circle at 80% 70%,#ffd700 4px,transparent 4px)}.chocolate-container{display:grid;gap:2px;background:#8b4513;padding:8px;border-radius:8px;border:3px solid #654321;margin:0 auto}.chocolate-piece{background:#d2691e;border:1px solid #8b4513;border-radius:3px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;font-size:.8rem;color:#654321}.chocolate-piece:hover{background:#cd853f}.chocolate-piece.filled{background:#654321;color:#d2691e}.cake-container{position:relative;width:200px;height:100px;background:#ffb6c1;border:3px solid #ff69b4;border-radius:0 0 50% 50%;margin:0 auto;overflow:hidden}.cake-slice{position:absolute;height:100%;border-right:2px solid #ff69b4;background:#ffc0cb;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;font-size:.8rem;color:#8b008b}.cake-slice:hover{background:#ffb6c1}.cake-slice.filled{background:#ff1493;color:#fff}.fraction-info{background:#f8f9fa;border:2px solid #dee2e6;border-radius:1rem;padding:1.5rem;text-align:center;min-width:250px}.fraction-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem}.fraction-stat{text-align:center}.fraction-stat-number{font-size:2rem;font-weight:700;color:#667eea}.fraction-stat-label{font-size:.9rem;color:#666}.info-project{background:linear-gradient(135deg,#fff 0%,#eff6ff 100%);border-radius:2rem;padding:3rem;box-shadow:0 8px 25px rgba(0,0,0,.1);margin:2rem 1rem}.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:2rem;text-align:center}.info-card{display:flex;flex-direction:column;align-items:center}.info-icon{width:80px;height:80px;border-radius:1rem;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;color:#fff;font-size:2rem}.icon-math{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%)}.icon-coding{background:linear-gradient(135deg,#10b981 0%,#059669 100%)}.icon-thinking{background:linear-gradient(135deg,#7c3aed 0%,#6d28d9 100%)}.footer{background:rgba(31,41,55,.95);color:#fff;text-align:center;padding:2rem;margin:2rem 1rem;border-radius:1rem;backdrop-filter:blur(10px)}.footer h3{color:#60a5fa;margin-bottom:.5rem}.colophon{background:rgba(255,255,255,.9);color:#666;text-align:center;padding:1rem;margin:1rem;border-radius:1rem;font-size:.9rem;border-top:2px solid #e2e8f0}.colophon p{margin-bottom:.5rem}.colophon .copyright{font-weight:700;color:#374151}.message{padding:1rem;border-radius:1rem;margin:1rem 0;text-align:center;font-weight:700;opacity:0;transform:translateY(-20px);transition:all .3s ease}.message.show{opacity:1;transform:translateY(0)}.message.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}.message.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.message.hint{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}.back-to-site{background:#607d8b;color:#fff;text-decoration:none;padding:.5rem 1rem;border-radius:50px;font-size:.9rem;transition:all .3s ease;display:inline-flex;align-items:center;gap:.5rem}.back-to-site:hover{background:#455a64;transform:translateY(-2px);text-decoration:none;color:#fff}@media (max-width:768px){.header h1{font-size:2rem}.classes-grid{grid-template-columns:1fr;padding:.5rem}.class-card{padding:1.5rem}.game-header{flex-direction:column;align-items:stretch}.question{font-size:1.5rem}.answers-grid{grid-template-columns:1fr;max-width:300px}.stats-bar{flex-direction:column;align-items:center}.addition-groups{flex-direction:column;gap:1rem}.operator{width:50px;height:50px;font-size:2rem}.pizza-container{width:200px;height:200px}.fraction-selector{flex-direction:column;align-items:center}}.hidden{display:none!important}
    </style>
</head>
<body>
    <div id="update-banner" class="banner-nascosto">
      <span>L'applicazione è stata aggiornata.</span>
      <button id="update-now-btn">Aggiorna subito</button>
      <button id="update-later-btn">Più tardi</button>
    </div>
    <div class="animated-bg">
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>

    <div class="main-container">
        <div id="homepage">
            <header class="header">
                <h1><img src="logo-colorato.png" alt="EduTechLab" style="width: 96px; height: 96px; vertical-align: middle; margin-right: 15px; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));"> EduTechLab</h1>
                <h2>Pensiero Computazionale per la Scuola Primaria</h2>
                <p>Scegli la tua classe e inizia il viaggio nel mondo del coding!</p>
            </header>
            <div id="stats-bar" class="stats-bar" style="display: none;">
                <div class="stat-item stat-stars">⭐ <span id="stars-count">0</span> stelle</div>
                <div class="stat-item stat-score">🏆 <span id="score-count">0</span> punti</div>
                <div class="stat-item stat-level">🧠 Livello <span id="level-count">1</span></div>
                <button class="nav-btn reset-btn" onclick="resetProgress()">🔄 Reset</button>
            </div>
            <div class="classes-grid">
                </div>
            <div class="info-project">
                </div>
            <footer class="footer">
                </footer>
        </div>
        <div id="gamesSection" class="games-section">
            </div>
        <div id="gameInterface" class="game-interface">
            </div>
    </div>

    <script>
        // ////////////// INIZIO LOGICA BANNER AGGIORNAMENTO //////////////
        let newWorker; // Variabile per tenere traccia del nuovo Service Worker

        function showUpdateBanner() {
            const banner = document.getElementById('update-banner');
            banner.classList.remove('banner-nascosto');

            document.getElementById('update-now-btn').addEventListener('click', () => {
                newWorker.postMessage({ action: 'skipWaiting' });
            });

            document.getElementById('update-later-btn').addEventListener('click', () => {
                banner.classList.add('banner-nascosto');
            });
        }
        
        function trackInstalling(worker) {
            worker.addEventListener('statechange', () => {
                if (worker.state === 'installed') {
                    newWorker = worker;
                    showUpdateBanner();
                }
            });
        }
        // ////////////// FINE LOGICA BANNER AGGIORNAMENTO //////////////

        // ////////////// INIZIO LOGICA GIOCO (IL TUO CODICE ORIGINALE) //////////////
        let currentClass = 1;
        let currentGame = '';
        let currentFractionType = 'pizza';
        let adaptiveData = {
            consecutiveCorrect: 0,
            consecutiveWrong: 0,
            totalQuestions: 0,
            correctAnswers: 0,
            currentDifficulty: 1,
            maxDifficulty: 5,
            hintLevel: 0
        };
        let gameState = {
            currentQuestion: null,
            userAnswer: null,
            isAnswered: false
        };
        let score = parseInt(localStorage.getItem('edutech_score') || '0');
        let stars = parseInt(localStorage.getItem('edutech_stars') || '0');
        let level = parseInt(localStorage.getItem('edutech_level') || '1');
        const contentGenerators={animals:["🐱","🐶","🐸","🦋","🐢","🐰","🦊","🐻","🦆","🐧","🐙","🐠","🦀","🐝","🐛"],fruits:["🍎","🍌","🍓","🍊","🍒","🥝","🍇","🍑","🥭","🍐","🫐","🥥","🍈","🍋","🥕"],objects:["⚽","🎈","🌟","🎁","📚","🧸","🚗","✏️","🎨","🧩","🎵","🏀","🎪","🎭","🎯"],colors:["🔴","🔵","🟡","🟢","🟠","🟣","🟤","⚫","⚪","🟥","🟦","🟨","🟩","🟧","🟪"],shapes:["⭐","🔶","🔷","⬜","⬛","🔸","🔹","🟢","🔴","🟡","🔵","🟣","🟠","🟤","⚪"],dailyRoutines:[{name:"Mattino a Scuola",sequence:[{emoji:"🛏️",text:"Mi sveglio"},{emoji:"🦷",text:"Mi lavo i denti"},{emoji:"🍞",text:"Faccio colazione"},{emoji:"🎒",text:"Preparo lo zaino"},{emoji:"🚌",text:"Vado a scuola"}]},{name:"Preparare una Pizza",sequence:[{emoji:"🌾",text:"Preparo la farina"},{emoji:"💧",text:"Aggiungo acqua"},{emoji:"🤲",text:"Impasto"},{emoji:"🍅",text:"Metto il pomodoro"},{emoji:"🧀",text:"Aggiungo il formaggio"}]},{name:"Piantare un Seme",sequence:[{emoji:"🌱",text:"Prendo il seme"},{emoji:"🪣",text:"Riempio il vaso"},{emoji:"☂️",text:"Faccio un buco"},{emoji:"🌱",text:"Metto il seme"},{emoji:"💧",text:"Innaffio"}]},{name:"Fare i Compiti",sequence:[{emoji:"🎒",text:"Apro lo zaino"},{emoji:"📚",text:"Prendo i libri"},{emoji:"✏️",text:"Preparo matita e penna"},{emoji:"📝",text:"Scrivo i compiti"},{emoji:"📚",text:"Ripongo tutto"}]}],variableScenarios:[{context:"videogioco",variables:[{name:"vite",description:"le vite del personaggio",min:1,max:5},{name:"livello",description:"il livello raggiunto",min:1,max:10},{name:"monete",description:"le monete raccolte",min:10,max:100},{name:"energia",description:"l'energia rimasta",min:20,max:100}]},{context:"scuola",variables:[{name:"compiti",description:"i compiti da fare",min:1,max:8},{name:"voto",description:"il voto della verifica",min:6,max:10},{name:"pagine",description:"le pagine lette",min:5,max:50},{name:"amici",description:"gli amici in classe",min:15,max:25}]},{context:"cucina",variables:[{name:"ingredienti",description:"gli ingredienti per la ricetta",min:3,max:8},{name:"minuti",description:"i minuti di cottura",min:10,max:60},{name:"porzioni",description:"le porzioni del dolce",min:4,max:12},{name:"temperatura",description:"i gradi del forno",min:160,max:200}]}],algorithmChallenges:[{type:"ordinamento",scenarios:[{task:"Ordinare i bambini per altezza",items:"bambini",criteria:"altezza"},{task:"Mettere i libri in ordine alfabetico",items:"libri",criteria:"titolo"},{task:"Sistemare i numeri dal più piccolo",items:"numeri",criteria:"valore"},{task:"Organizzare i colori per intensità",items:"colori",criteria:"intensità"}]},{type:"ricerca",scenarios:[{task:"Trovare il libro giusto nella biblioteca",strategy:"dividere gli scaffali"},{task:"Cercare un amico nel parco",strategy:"guardare nelle aree più frequentate"},{task:"Trovare la chiave di casa",strategy:"controllare i posti usuali"},{task:"Scegliere il regalo perfetto",strategy:"pensare ai gusti della persona"}]}]};
        const classesData={1:{name:"Prima Primaria",emoji:"🌱",description:"I primi passi nel mondo digitale",age:"6-7 anni",games:[{id:"conteggio",name:"🔢 Conteggio Magico",description:"Conta oggetti e associa al numero"},{id:"addizioni-visual",name:"➕ Addizioni Visual",description:"Somme fino a 10 con oggetti colorati"},{id:"sequenze-base",name:"📝 Prime Sequenze",description:"Ordinare azioni quotidiane"},{id:"pattern-semplici",name:"🌈 Trova il Pattern",description:"Riconosci sequenze colorate"}]},2:{name:"Seconda Primaria",emoji:"🌿",description:"Esploratori digitali curiosi",age:"7-8 anni",games:[{id:"conteggio",name:"🔢 Conteggio Avanzato",description:"Conta oggetti fino a 20"},{id:"operazioni-entro-20",name:"🧮 Operazioni entro il 20",description:"Addizioni e sottrazioni veloci"},{id:"addizioni-visual",name:"➕ Addizioni Avanzate",description:"Somme con raggruppamenti"},{id:"pattern-semplici",name:"🎨 Pattern Creativi",description:"Pattern più complessi"},{id:"sequenze-base",name:"📝 Sequenze Avanzate",description:"Storie più articolate"},{id:"debugging-visuale",name:"🐛 Detective del Codice",description:"Trova gli errori nelle sequenze"}]},3:{name:"Terza Primaria",emoji:"🌳",description:"Logica e primi algoritmi",age:"8-9 anni",games:[{id:"conteggio",name:"🔢 Conteggio Strategico",description:"Strategie di conteggio efficaci"},{id:"operazioni-entro-20",name:"🧮 Operazioni Rapide",description:"Calcolo mentale veloce"},{id:"tabelline-base",name:"✖️ Tabelline Interattive",description:"Moltiplicazioni fino alla tavola del 5"},{id:"addizioni-visual",name:"➕ Operazioni Complesse",description:"Addizioni e sottrazioni avanzate"},{id:"loop-semplici",name:"🔄 I Miei Primi Loop",description:"Ripetizioni e cicli semplici"},{id:"if-then-base",name:"🤔 Se... Allora...",description:"Prime condizioni logiche"},{id:"debugging-visuale",name:"🐛 Debug Master",description:"Debugging di algoritmi"}]},4:{name:"Quarta Primaria",emoji:"🌲",description:"Algoritmi avanzati",age:"9-10 anni",games:[{id:"conteggio",name:"🔢 Conteggio Professionale",description:"Strategie avanzate di conteggio"},{id:"operazioni-entro-20",name:"🧮 Calcoli Complessi",description:"Operazioni con numeri grandi"},{id:"tabelline-base",name:"✖️ Tabelline Complete",description:"Tutte le tabelline fino al 10"},{id:"frazioni-visual",name:"🍕 Frazioni Interattive",description:"Visualizza e opera con le frazioni"},{id:"addizioni-visual",name:"➕ Aritmetica Avanzata",description:"Operazioni con numeri decimali"},{id:"variabili-semplici",name:"📦 Le Mie Prime Variabili",description:"Contenitori per i dati"},{id:"algoritmi-avanzati",name:"🧠 Algoritmi Intelligenti",description:"Strategie di risoluzione complesse"},{id:"debugging-visuale",name:"🐛 Debug Expert",description:"Debugging avanzato"}]},5:{name:"Quinta Primaria",emoji:"🌺",description:"Programmatori junior",age:"10-11 anni",games:[{id:"conteggio",name:"🔢 Conteggio Esperto",description:"Metodi di conteggio combinatorio"},{id:"operazioni-entro-20",name:"🧮 Matematica Superiore",description:"Operazioni con tutti i numeri"},{id:"tabelline-base",name:"✖️ Moltiplicazioni Expert",description:"Calcoli rapidi e trucchi"},{id:"frazioni-visual",name:"🍕 Frazioni Master",description:"Operazioni con frazioni"},{id:"statistica-base",name:"📊 I Miei Primi Grafici",description:"Raccogli e analizza dati"},{id:"variabili-semplici",name:"📦 Variabili Avanzate",description:"Programmazione con variabili"},{id:"algoritmi-avanzati",name:"🧠 Algoritmi Pro",description:"Ottimizzazione e ricerca"},{id:"progetti-completi",name:"🎮 Crea il Tuo Gioco",description:"Progetti completi con interfaccia"},{id:"collaborazione-digitale",name:"🤝 Coding di Squadra",description:"Progetti collaborativi"}]}};
        let deferredPrompt;window.addEventListener("beforeinstallprompt",e=>{deferredPrompt=e;console.log("PWA installable")});function loadAdaptiveData(){const e=localStorage.getItem("edutech_adaptive");e&&(adaptiveData={...adaptiveData,...JSON.parse(e)});updateStatsDisplay()}function saveAdaptiveData(){localStorage.setItem("edutech_adaptive",JSON.stringify(adaptiveData));updateStatsDisplay()}function updateStatsDisplay(){document.getElementById("totalQuestions").textContent=adaptiveData.totalQuestions;document.getElementById("correctAnswers").textContent=adaptiveData.correctAnswers;const e=adaptiveData.totalQuestions>0?Math.round(adaptiveData.correctAnswers/adaptiveData.totalQuestions*100):0;document.getElementById("accuracyRate").textContent=e+"%";document.getElementById("currentLevel").textContent=adaptiveData.currentDifficulty;document.querySelectorAll(".difficulty-star").forEach((e,t)=>{e.classList.toggle("active",t<adaptiveData.currentDifficulty)});document.querySelectorAll("#stars-count, #class-stars").forEach(e=>{e.textContent=stars});document.querySelectorAll("#score-count, #class-score").forEach(e=>{e.textContent=score});document.querySelectorAll("#level-count, #class-level").forEach(e=>{e.textContent=level});(score>0||stars>0)&&(document.getElementById("stats-bar").style.display="flex")}function getRandomElements(e,t){const n=[...e].sort(()=>.5-Math.random());return n.slice(0,t)}function generateDynamicNumbers(e,t,n=[]){const o=[];for(let a=e;a<=t;a++)n.includes(a)||o.push(a);return o.sort(()=>.5-Math.random())}function selectClass(e){currentClass=e;const t=classesData[e];document.getElementById("homepage").style.display="none";document.getElementById("gamesSection").style.display="block";document.getElementById("classTitle").textContent=`${t.emoji} ${t.name} - ${t.description}`;loadGamesForClass(e)}function loadGamesForClass(e){const t=classesData[e].games,n=document.getElementById("gamesGrid");n.innerHTML="";t.forEach(e=>{const t=document.createElement("div");t.className="game-card";t.onclick=()=>startGame(e.id,e.name);t.innerHTML=`
                    <h3>${e.name}</h3>
                    <p>${e.description}</p>
                    <div style="margin-top: 1rem; color: #059669; font-weight: bold;">
                        ✅ Gioco attivo
                    </div>
                `;n.appendChild(t)})}function startGame(e,t){currentGame=e;document.getElementById("gamesSection").style.display="none";document.getElementById("gameInterface").style.display="block";document.getElementById("gameTitle").textContent=t;gameState={currentQuestion:null,userAnswer:null,isAnswered:!1};document.getElementById("hintContainer").style.display="none";generateQuestion()}function generateQuestion(){gameState.isAnswered=!1;document.getElementById("checkAnswerBtn").style.display="none";hideMessage();hideHint();switch(currentGame){case"conteggio":generateCountingQuestion();break;case"addizioni-visual":generateAdditionQuestion();break;case"operazioni-entro-20":generateOperationsQuestion();break;case"sequenze-base":generateSequenceQuestion();break;case"pattern-semplici":generatePatternQuestion();break;case"debugging-visuale":generateDebuggingQuestion();break;case"tabelline-base":generateMultiplicationQuestion();break;case"loop-semplici":generateLoopQuestion();break;case"if-then-base":generateConditionalQuestion();break;case"frazioni-visual":generateFractionQuestion();break;case"variabili-semplici":generateVariableQuestion();break;case"algoritmi-avanzati":generateAlgorithmQuestion();break;case"statistica-base":generateStatisticsQuestion();break;case"progetti-completi":generateProjectQuestion();break;case"collaborazione-digitale":generateCollaborationQuestion();break;default:generateCountingQuestion()}}function generateCountingQuestion(){const e=currentClass;let t;switch(e){case 1:t=Math.min(5+2*adaptiveData.currentDifficulty,10);break;case 2:t=Math.min(8+3*adaptiveData.currentDifficulty,20);break;case 3:t=Math.min(10+4*adaptiveData.currentDifficulty,30);break;case 4:t=Math.min(15+5*adaptiveData.currentDifficulty,50);break;case 5:t=Math.min(20+6*adaptiveData.currentDifficulty,100);break;default:t=10}const n=Math.floor(Math.random()*t)+1,o=Object.keys(contentGenerators).filter(e=>Array.isArray(contentGenerators[e])),a=o[Math.floor(Math.random()*o.length)],r=contentGenerators[a],s=r[Math.floor(Math.random()*r.length)];gameState.currentQuestion={count:n,object:s};document.getElementById("gameContent").innerHTML=`
                <div class="question">Conta tutti gli oggetti!</div>
                <div class="counting-objects">
                    ${Array(n).fill(s).map((e,t)=>`<div class="counting-object" style="animation-delay: ${.1*t}s">${e}</div>`).join("")}
                </div>
                <div class="answers-grid">
                    ${generateNumberOptions(n,4).map(e=>`<button class="answer-btn" onclick="selectAnswer(${e})">${e}</button>`).join("")}
                </div>
            `}function generateAdditionQuestion(){const e=currentClass;let t;switch(e){case 1:t=Math.min(5+adaptiveData.currentDifficulty,10);break;case 2:t=Math.min(8+2*adaptiveData.currentDifficulty,15);break;case 3:t=Math.min(10+3*adaptiveData.currentDifficulty,20);break;case 4:t=Math.min(15+4*adaptiveData.currentDifficulty,50);break;case 5:t=Math.min(20+5*adaptiveData.currentDifficulty,100);break;default:t=10}const n=Math.floor(Math.random()*t)+1,o=Math.floor(Math.random()*(t-n))+1,a=n+o;gameState.currentQuestion={a:n,b:o,result:a};const r=e<=3;document.getElementById("gameContent").innerHTML=`
                <div class="question">${n} + ${o} = ?</div>
                ${r?`
                <div class="addition-groups">
                    <div class="addition-group">
                        <div class="group-label">Primo gruppo</div>
                        <div class="objects-container">
                            ${Array(n).fill("").map((e,t)=>`<div class="visual-object" style="background: #3B82F6; animation-delay: ${.1*t}s;">${t+1}</div>`).join("")}
                        </div>
                    </div>
                    <div class="operator">+</div>
                    <div class="addition-group">
                        <div class="group-label">Secondo gruppo</div>
                        <div class="objects-container">
                            ${Array(o).fill("").map((e,t)=>`<div class="visual-object" style="background: #EF4444; animation-delay: ${.1*(n+t)}s;">${t+1}</div>`).join("")}
                        </div>
                    </div>
                    <div class="operator">=</div>
                    <div class="addition-group">
                        <div class="group-label">Risultato</div>
                        <div style="font-size: 3rem; color: #4CAF50;">?</div>
                    </div>
                </div>
                `:""}
                <div class="answers-grid">
                    ${generateNumberOptions(a,4).map(e=>`<button class="answer-btn" onclick="selectAnswer(${e})">${e}</button>`).join("")}
                </div>
            `}function generateOperationsQuestion(){const e=["+","-"],t=e[Math.floor(Math.random()*e.length)],n=Math.min(10+3*adaptiveData.currentDifficulty,30);let o,a,r;if("+"===t){o=Math.floor(Math.random()*n)+1;a=Math.floor(Math.random()*(n-o))+1;r=o+a}else{r=Math.floor(Math.random()*n)+1;a=Math.floor(Math.random()*r)+1;o=r+a;r=o-a}gameState.currentQuestion={result:r};document.getElementById("gameContent").innerHTML=`
                <div class="question">${o} ${t} ${a} = ?</div>
                <div class="answers-grid">
                    ${generateNumberOptions(r,4).map(e=>`<button class="answer-btn" onclick="selectAnswer(${e})">${e}</button>`).join("")}
                </div>
            `}function generateMultiplicationQuestion(){const e=currentClass;let t;switch(e){case 3:t=Math.min(3+adaptiveData.currentDifficulty,5);break;case 4:t=Math.min(5+adaptiveData.currentDifficulty,8);break;case 5:t=Math.min(7+adaptiveData.currentDifficulty,12);break;default:t=5}const n=Math.floor(Math.random()*t)+1,o=Math.floor(Math.random()*10)+1,a=n*o;gameState.currentQuestion={result:a};document.getElementById("gameContent").innerHTML=`
                <div class="question">${n} × ${o} = ?</div>
                ${e<=4?generateMultiplicationVisual(n,o):""}
                <div class="answers-grid">
                    ${generateNumberOptions(a,4).map(e=>`<button class="answer-btn" onclick="selectAnswer(${e})">${e}</button>`).join("")}
                </div>
            `}function generateMultiplicationVisual(e,t){return`
                <div class="addition-groups">
                    ${Array(t).fill(0).map((t,n)=>`
                        <div class="addition-group">
                            <div class="group-label">Gruppo ${n+1}</div>
                            <div class="objects-container">
                                ${Array(e).fill(0).map((e,t)=>`
                                    <div class="visual-object" style="background: #F59E0B;">${t+1}</div>
                                `).join("")}
                            </div>
                        </div>
                    `).join("")}
                </div>
            `}function generateSequenceQuestion(){const e=contentGenerators.dailyRoutines,t=e[Math.floor(Math.random()*e.length)],n=t.sequence.map((e,t)=>({...e,correctIndex:t})),o=[...n].sort(()=>Math.random()-.5);gameState.currentQuestion={routine:t,correct:n,shuffled:o,userOrder:[]};document.getElementById("gameContent").innerHTML=`
                <div class="sequence-instructions">
                    <h3>📋 Come funziona:</h3>
                    <p>Devi mettere in ordine le azioni per <strong>"${t.name}"</strong></p>
                    <p>Clicca le azioni nel giusto ordine (da 1 a ${t.sequence.length})</p>
                </div>
                
                <div class="question">Metti in ordine: ${t.name}</div>
                
                <div class="sequence-story">
                    <strong>Cosa devi fare:</strong> Riordina queste azioni nella sequenza corretta!
                </div>
                
                <div class="sequence-options">
                    ${o.map((e,t)=>`<div class="sequence-option" onclick="selectSequenceItem(${e.correctIndex}, '${e.text}', this)">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${e.emoji}</div>
                            <div>${e.text}</div>
                        </div>`).join("")}
                </div>
                
                <div style="margin-top: 2rem;">
                    <div style="font-weight: bold; font-size: 1.2rem; color: #374151;">La tua sequenza:</div>
                    <div id="selectedSequence" style="font-size: 1.5rem; margin-top: 1rem; min-height: 2rem; background: #F3F4F6; padding: 1rem; border-radius: 0.5rem;">
                        <em>Inizia cliccando la prima azione...</em>
                    </div>
                </div>
            `;document.getElementById("checkAnswerBtn").style.display="inline-block"}function selectSequenceItem(e,t,n){if(n.classList.contains("selected"))return;n.classList.add("selected");const o=gameState.currentQuestion.userOrder.length+1;n.innerHTML+=`<div class="sequence-number">${o}</div>`;gameState.currentQuestion.userOrder.push({correctIndex:e,text:t});const a=gameState.currentQuestion.userOrder.map((e,t)=>`${t+1}. ${e.text}`).join("<br>");document.getElementById("selectedSequence").innerHTML=a||"<em>Inizia cliccando la prima azione...</em>"}function generatePatternQuestion(){const e=currentClass;let t,n;if(e<=2){t=[contentGenerators.colors.slice(0,3),contentGenerators.shapes.slice(0,3),contentGenerators.fruits.slice(0,3)];n=2}else if(e<=3){t=[contentGenerators.colors,contentGenerators.shapes,contentGenerators.animals.slice(0,4)];n=3}else{t=[contentGenerators.colors,contentGenerators.shapes,contentGenerators.animals,contentGenerators.objects];n=Math.min(3+adaptiveData.currentDifficulty,5)}const o=t[Math.floor(Math.random()*t.length)],a=getRandomElements(o,n),r=2+adaptiveData.currentDifficulty;let s=[];for(let l=0;l<r;l++)s=s.concat(a);const c=s.pop();gameState.currentQuestion={pattern:s,correct:c};const i=o.filter(e=>e!==c),d=[c,...getRandomElements(i,3)],u=d.sort(()=>Math.random()-.5);document.getElementById("gameContent").innerHTML=`
                <div class="question">Quale elemento completa il pattern?</div>
                <div class="pattern-container">
                    ${s.map(e=>`<div class="pattern-item">${e}</div>`).join("")}
                    <div class="pattern-item" style="border: 3px dashed #667eea; background: #F3F4F6;">?</div>
                </div>
                <div class="answers-grid">
                    ${u.map(e=>`<button class="answer-btn" onclick="selectAnswer('${e}')">${e}</button>`).join("")}
                </div>
            `}function generateDebuggingQuestion(){const e=contentGenerators.dailyRoutines,t=e[Math.floor(Math.random()*e.length)],n=t.sequence.map(e=>e.emoji),o=Math.floor(Math.random()*n.length),a=[...n],r=[...contentGenerators.animals,...contentGenerators.fruits,...contentGenerators.objects];let s;do{s=r[Math.floor(Math.random()*r.length)]}while(n.includes(s));a[o]=s;gameState.currentQuestion={error:o};document.getElementById("gameContent").innerHTML=`
                <div class="question">🐛 Trova l'errore nella sequenza "${t.name}"!</div>
                <div class="sequence-story">
                    <strong>Sequenza corretta:</strong> ${n.join(" → ")}<br>
                    <strong>Sequenza con errore:</strong> ${a.join(" → ")}
                </div>
                <div class="pattern-container">
                    ${a.map((e,t)=>`<div class="pattern-item" onclick="selectAnswer(${t})">${e}</div>`).join("")}
                </div>
                <p>Clicca sull'elemento che NON dovrebbe essere lì!</p>
            `}function generateLoopQuestion(){const e=[{action:"salta",emoji:"🦘"},{action:"gira",emoji:"🌀"},{action:"cammina",emoji:"🚶"},{action:"batti le mani",emoji:"👏"},{action:"alza le braccia",emoji:"🙌"}],t=e[Math.floor(Math.random()*e.length)],n=Math.floor(Math.random()*8)+2;gameState.currentQuestion={result:n};document.getElementById("gameContent").innerHTML=`
                <div class="question">Algoritmo: Ripeti "${t.action}" ${n} volte</div>
                <div style="font-size: 4rem; margin: 2rem 0;">${t.emoji}</div>
                <div style="font-size: 1.2rem; margin: 1rem 0; background: #E3F2FD; padding: 1rem; border-radius: 0.5rem;">
                    <strong>🔄 Loop:</strong> Per ripetere "${t.action}" ${n} volte, 
                    quante volte devo eseguire l'azione?
                </div>
                <div class="answers-grid">
                    ${generateNumberOptions(n,4).map(e=>`<button class="answer-btn" onclick="selectAnswer(${e})">${e}</button>`).join("")}
                </div>
            `}function generateConditionalQuestion(){const e=[{condition:"piove",emoji:"🌧️",actions:["prendi l'ombrello","metti l'impermeabile","resta in casa"],correct:"prendi l'ombrello"},{condition:"c'è il sole",emoji:"☀️",actions:["metti gli occhiali da sole","prendi l'ombrello","metti il cappotto"],correct:"metti gli occhiali da sole"},{condition:"hai fame",emoji:"😋",actions:["mangia qualcosa","vai a dormire","studia"],correct:"mangia qualcosa"},{condition:"sei stanco",emoji:"😴",actions:["riposati","corri","studia"],correct:"riposati"},{condition:"è freddo",emoji:"🥶",actions:["metti il cappotto","metti i sandali","togli la maglietta"],correct:"metti il cappotto"}],t=e[Math.floor(Math.random()*e.length)];gameState.currentQuestion={correct:t.correct};const n=t.actions.sort(()=>Math.random()-.5);document.getElementById("gameContent").innerHTML=`
                <div class="question">🤔 SE ${t.condition} ${t.emoji}, ALLORA che cosa fai?</div>
                <div style="background: #FFF9C4; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>Regola IF-THEN:</strong><br>
                    SE (condizione) ALLORA (azione logica)
                </div>
                <div class="answers-grid">
                    ${n.map(e=>`<button class="answer-btn" onclick="selectAnswer('${e}')">${e}</button>`).join("")}
                </div>
            `}function generateFractionQuestion(){const e=currentClass>=5?[2,3,4,6,8]:[2,3,4,6],t=e[Math.floor(Math.random()*e.length)],n=Math.floor(Math.random()*t)+1,o=["pizza","chocolate","cake"];currentFractionType=o[Math.floor(Math.random()*o.length)];gameState.currentQuestion={numerator:n,denominator:t,type:currentFractionType};let a="";"pizza"===currentFractionType?a=generatePizzaVisualization(t):"chocolate"===currentFractionType?a=generateChocolateVisualization(t):a=generateCakeVisualization(t);document.getElementById("gameContent").innerHTML=`
                <div class="question">Seleziona ${n}/${t} ${getFractionTypeText(currentFractionType)}!</div>
                
                <div class="fraction-visual">
                    <div class="fraction-selector">
                        <div class="fraction-type ${"pizza"===currentFractionType?"active":""}" onclick="changeFractionType('pizza')">
                            🍕 Pizza
                        </div>
                        <div class="fraction-type ${"chocolate"===currentFractionType?"active":""}" onclick="changeFractionType('chocolate')">
                            🍫 Cioccolato
                        </div>
                        <div class="fraction-type ${"cake"===currentFractionType?"active":""}" onclick="changeFractionType('cake')">
                            🎂 Torta
                        </div>
                    </div>
                    
                    <div class="fraction-display">
                        ${a}
                    </div>
                    
                    <div class="fraction-info">
                        <div style="font-size: 1.5rem; margin-bottom: 1rem;">
                            <strong>Frazione target: ${n}/${t}</strong>
                        </div>
                        <div class="fraction-stats">
                            <div class="fraction-stat">
                                <div class="fraction-stat-number" id="selectedPieces">0</div>
                                <div class="fraction-stat-label">Selezionate</div>
                            </div>
                            <div class="fraction-stat">
                                <div class="fraction-stat-number">${t}</div>
                                <div class="fraction-stat-label">Totali</div>
                            </div>
                            <div class="fraction-stat">
                                <div class="fraction-stat-number" id="currentFraction">0/${t}</div>
                                <div class="fraction-stat-label">Frazione attuale</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;setupFractionInteractions();document.getElementById("checkAnswerBtn").style.display="inline-block"}function getFractionTypeText(e){switch(e){case"pizza":return"della pizza";case"chocolate":return"del cioccolato";case"cake":return"della torta";default:return"dell'oggetto"}}function generatePizzaVisualization(e){return`
                <div class="pizza-container" id="fractionContainer">
                    ${Array(e).fill(0).map((e,t)=>`<div class="pizza-slice" data-piece="${t}" onclick="toggleFractionPiece(this)"></div>`).join("")}
                </div>
            `}function generateChocolateVisualization(e){const t=Math.ceil(Math.sqrt(e)),n=Math.ceil(e/t);return`
                <div class="chocolate-container" id="fractionContainer" style="grid-template-columns: repeat(${n}, 50px); grid-template-rows: repeat(${t}, 40px);">
                    ${Array(e).fill(0).map((e,t)=>`<div class="chocolate-piece" data-piece="${t}" onclick="toggleFractionPiece(this)">${t+1}</div>`).join("")}
                </div>
            `}function generateCakeVisualization(e){return`
                <div class="cake-container" id="fractionContainer">
                    ${Array(e).fill(0).map((t,n)=>`<div class="cake-slice" data-piece="${n}" onclick="toggleFractionPiece(this)" 
                             style="left: ${n*200/e}px; width: ${200/e}px;">${n+1}</div>`).join("")}
                </div>
            `}function setupFractionInteractions(){if("pizza"===currentFractionType){const e=document.querySelectorAll(".pizza-slice"),t=gameState.currentQuestion.denominator;e.forEach((e,n)=>{const o=360/t*n,a=360/t*(n+1),r=50,s=50,l=47,c=(o-90)*Math.PI/180,i=(a-90)*Math.PI/180,d=r+l*Math.cos(c),u=s+l*Math.sin(c),g=r+l*Math.cos(i),m=s+l*Math.sin(i);e.style.clipPath=`polygon(${r}% ${s}%, ${d}% ${u}%, ${g}% ${m}%)`;e.style.transform="none";e.style.top="0";e.style.left="0";e.style.width="100%";e.style.height="100%"})}}function changeFractionType(e){currentFractionType=e;gameState.currentQuestion.type=e;let t="";"pizza"===e?t=generatePizzaVisualization(gameState.currentQuestion.denominator):"chocolate"===e?t=generateChocolateVisualization(gameState.currentQuestion.denominator):t=generateCakeVisualization(gameState.currentQuestion.denominator);document.querySelector(".fraction-display").innerHTML=t;document.querySelectorAll(".fraction-type").forEach(e=>e.classList.remove("active"));document.querySelector(`.fraction-type:nth-child(${["pizza","chocolate","cake"].indexOf(e)+1})`).classList.add("active");document.getElementById("selectedPieces").textContent="0";document.getElementById("currentFraction").textContent=`0/${gameState.currentQuestion.denominator}`;setupFractionInteractions()}function toggleFractionPiece(e){e.classList.toggle("filled");const t=document.querySelectorAll(`#fractionContainer .${"pizza"===currentFractionType?"pizza-slice":"chocolate"===currentFractionType?"chocolate-piece":"cake-slice"}.filled`).length;document.getElementById("selectedPieces").textContent=t;document.getElementById("currentFraction").textContent=`${t}/${gameState.currentQuestion.denominator}`}function generateVariableQuestion(){const e=contentGenerators.variableScenarios,t=e[Math.floor(Math.random()*e.length)],n=t.variables[Math.floor(Math.random()*t.variables.length)],o=Math.floor(Math.random()*(n.max-n.min+1))+n.min,a=[{question:`Nel ${t.context}, la variabile "${n.name}" contiene ${n.description}. Se "${n.name}" = ${o}, quanto vale ${n.name} + 5?`,result:o+5},{question:`Nel ${t.context}, se la variabile "${n.name}" (${n.description}) vale ${o}, quanto vale ${n.name} - 3?`,result:Math.max(0,o-3)},{question:`Nel ${t.context}, la variabile "${n.name}" rappresenta ${n.description}. Se "${n.name}" = ${o}, qual è il valore di "${n.name}"?`,result:o}],r=a[Math.floor(Math.random()*a.length)];gameState.currentQuestion={result:r.result};document.getElementById("gameContent").innerHTML=`
                <div class="question">${r.question}</div>
                <div style="background: #E8F5E8; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>📦 Ricorda:</strong> Una variabile è come una scatola con un'etichetta che contiene un valore!
                </div>
                <div class="answers-grid">
                    ${generateNumberOptions(r.result,4).map(e=>`<button class="answer-btn" onclick="selectAnswer(${e})">${e}</button>`).join("")}
                </div>
            `}function generateAlgorithmQuestion(){const e=contentGenerators.algorithmChallenges,t=e[Math.floor(Math.random()*e.length)],n=t.scenarios[Math.floor(Math.random()*t.scenarios.length)];let o,a,r;if("ordinamento"===t.type){const s=["Confrontare ogni elemento con il successivo","Trovare prima il più piccolo, poi il secondo più piccolo...","Dividere in gruppi più piccoli e ordinare","Usare le dita per tenere traccia"];r=s[Math.floor(Math.random()*2)];a=[r,...getRandomElements(s.filter(e=>e!==r),3)];o=`${n.task}. Quale strategia è più efficace?`}else{const l=[n.strategy,"Guardare a caso","Chiedere a tutti","Aspettare che arrivi da solo"];r=n.strategy;a=l;o=`${n.task}. Quale strategia usi?`}gameState.currentQuestion={correct:r};const c=a.sort(()=>Math.random()-.5);document.getElementById("gameContent").innerHTML=`
                <div class="question">${o}</div>
                <div style="background: #F0F8F0; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>🧠 Algoritmo:</strong> Una sequenza di passi logici per risolvere un problema!
                </div>
                <div class="sequence-options">
                    ${c.map(e=>`<div class="sequence-option" onclick="selectAnswer('${e}')">
                            ${e}
                        </div>`).join("")}
                </div>
            `}function generateStatisticsQuestion(){const e=Math.min(5+adaptiveData.currentDifficulty,8),t=Array.from({length:e},()=>Math.floor(Math.random()*20)+1),n=[{type:"media",question:`Calcola la media dei voti: ${t.join(", ")}`,result:Math.round(t.reduce((e,t)=>e+t,0)/t.length)},{type:"massimo",question:`Trova il numero più grande: ${t.join(", ")}`,result:Math.max(...t)},{type:"minimo",question:`Trova il numero più piccolo: ${t.join(", ")}`,result:Math.min(...t)},{type:"somma",question:`Calcola la somma totale: ${t.join(", ")}`,result:t.reduce((e,t)=>e+t,0)}],o=n[Math.floor(Math.random()*n.length)];gameState.currentQuestion={result:o.result};document.getElementById("gameContent").innerHTML=`
                <div class="question">${o.question}</div>
                <div style="background: #E8F5F9; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>📊 Statistica:</strong> Analizziamo i dati per trovare informazioni utili!
                    <br><strong>Tipo:</strong> ${o.type.toUpperCase()}
                </div>
                <div style="background: #F5F5F5; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; font-family: monospace; font-size: 1.3rem;">
                    Dati: [${t.join(", ")}]
                </div>
                <div class="answers-grid">
                    ${generateNumberOptions(o.result,4).map(e=>`<button class="answer-btn" onclick="selectAnswer(${e})">${e}</button>`).join("")}
                </div>
            `}function generateProjectQuestion(){const e=[{project:"Un gioco di memoria",components:["pulsanti colorati","suoni","timer","grafica"],correct:"pulsanti colorati",explanation:"I pulsanti sono essenziali per l'interazione!"},{project:"Un calcolatore",components:["numeri e operatori","colori","musica","animazioni"],correct:"numeri e operatori",explanation:"Senza numeri non puoi fare calcoli!"},{project:"Un quiz educativo",components:["domande e risposte","effetti speciali","mascotte","sfondi"],correct:"domande e risposte",explanation:"Le domande sono il cuore del quiz!"},{project:"Un'app per disegnare",components:["strumenti di disegno","chat","calendario","meteo"],correct:"strumenti di disegno",explanation:"Servono pennelli, colori e canvas!"}],t=e[Math.floor(Math.random()*e.length)];gameState.currentQuestion={correct:t.correct,explanation:t.explanation};const n=t.components.sort(()=>Math.random()-.5);document.getElementById("gameContent").innerHTML=`
                <div class="question">🎮 Per creare "${t.project}", quale componente è più importante?</div>
                <div style="background: #FFF3E0; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>💡 Progettazione:</strong> Ogni progetto ha componenti essenziali e opzionali.
                    <br>Pensa a cosa serve DAVVERO per far funzionare il progetto!
                </div>
                <div class="sequence-options">
                    ${n.map(e=>`<div class="sequence-option" onclick="selectAnswer('${e}')">
                            ${e}
                        </div>`).join("")}
                </div>
            `}function generateCollaborationQuestion(){const e=[{scenario:"Stai lavorando in team su un progetto di coding e devi condividere il tuo codice",tools:["repository condiviso (Git)","email","telefono","biglietti"],correct:"repository condiviso (Git)",explanation:"Git permette di collaborare sul codice in sicurezza!"},{scenario:"Il tuo compagno ha fatto delle modifiche al progetto e vuoi vedere cosa ha cambiato",tools:["sistema di controllo versioni","indovinare","chiedere agli altri","rifare tutto"],correct:"sistema di controllo versioni",explanation:"Permette di vedere tutte le modifiche!"},{scenario:"Vuoi lasciare un commento sul lavoro del tuo gruppo per dare un suggerimento",tools:["sistema di commenti","messaggi privati","ignorare","cancellare tutto"],correct:"sistema di commenti",explanation:"I commenti aiutano il team a migliorare!"},{scenario:"Due persone del team hanno modificato la stessa parte del codice contemporaneamente",tools:["sistema di merge e conflitti","scegliere a caso","litigare","ricominciare"],correct:"sistema di merge e conflitti",explanation:"I sistemi moderni aiutano a risolvere i conflitti!"}],t=e[Math.floor(Math.random()*e.length)];gameState.currentQuestion={correct:t.correct,explanation:t.explanation};const n=t.tools.sort(()=>Math.random()-.5);document.getElementById("gameContent").innerHTML=`
                <div class="question">🤝 ${t.scenario}. Quale strumento usi?</div>
                <div style="background: #E8F5E8; padding: 1.5rem; border-radius: 1rem; margin: 2rem 0;">
                    <strong>👥 Collaborazione:</strong> Nel mondo del coding si lavora spesso in team.
                    <br>Gli strumenti giusti rendono tutto più facile!
                </div>
                <div class="sequence-options">
                    ${n.map(e=>`<div class="sequence-option" onclick="selectAnswer('${e}')">
                            ${e}
                        </div>`).join("")}
                </div>
            `}function selectAnswer(e){if(gameState.isAnswered)return;gameState.userAnswer=e;gameState.isAnswered=!0;document.querySelectorAll(".answer-btn, .sequence-option").forEach(e=>{e.style.pointerEvents="none"});checkAnswerLogic()}function checkAnswer(){if(gameState.isAnswered)return;let e=!1;switch(currentGame){case"sequenze-base":const t=gameState.currentQuestion.userOrder.map(e=>e.correctIndex),n=gameState.currentQuestion.correct.map((e,t)=>t);e=JSON.stringify(t)===JSON.stringify(n);break;case"frazioni-visual":const o=document.querySelectorAll(`#fractionContainer .${"pizza"===currentFractionType?"pizza-slice":"chocolate"===currentFractionType?"chocolate-piece":"cake-slice"}.filled`).length;e=o===gameState.currentQuestion.numerator;break;default:return}gameState.isAnswered=!0;processAnswer(e)}function checkAnswerLogic(){let e=!1;switch(currentGame){case"conteggio":e=gameState.userAnswer===gameState.currentQuestion.count;break;case"addizioni-visual":case"operazioni-entro-20":case"tabelline-base":case"loop-semplici":case"variabili-semplici":case"algoritmi-avanzati":case"statistica-base":e=gameState.userAnswer===gameState.currentQuestion.result;break;case"pattern-semplici":case"if-then-base":case"progetti-completi":case"collaborazione-digitale":e=gameState.userAnswer===gameState.currentQuestion.correct;break;case"debugging-visuale":e=gameState.userAnswer===gameState.currentQuestion.error;break;default:e=gameState.userAnswer===(gameState.currentQuestion.correct||gameState.currentQuestion.result)}processAnswer(e)}function processAnswer(e){adaptiveData.totalQuestions++;if(e){adaptiveData.correctAnswers++;adaptiveData.consecutiveCorrect++;adaptiveData.consecutiveWrong=0;adaptiveData.hintLevel=0;let t="Corretto! Ottimo lavoro! 🎉";gameState.currentQuestion.explanation&&(t+=`<br><br>💡 ${gameState.currentQuestion.explanation}`);showMessage(t,"success");const n=10*adaptiveData.currentDifficulty*currentClass;score+=n;stars+=adaptiveData.currentDifficulty;if(adaptiveData.consecutiveCorrect>=3&&adaptiveData.currentDifficulty<adaptiveData.maxDifficulty){adaptiveData.currentDifficulty++;level=adaptiveData.currentDifficulty;adaptiveData.consecutiveCorrect=0;showMessage("Livello aumentato! Sei diventato più bravo! ⭐","success")}document.querySelectorAll(".answer-btn, .sequence-option").forEach(e=>{const t=e.textContent.trim(),n=String(gameState.userAnswer).trim();t!==n&&!t.includes(n)||e.classList.add("correct")})}else{adaptiveData.consecutiveWrong++;adaptiveData.consecutiveCorrect=0;adaptiveData.hintLevel++;let o="Non è corretto. Riprova! 💪";gameState.currentQuestion.explanation&&(o+=`<br><br>💡 Suggerimento: ${gameState.currentQuestion.explanation}`);showMessage(o,"error");if(adaptiveData.consecutiveWrong>=3&&adaptiveData.currentDifficulty>1){adaptiveData.currentDifficulty--;level=adaptiveData.currentDifficulty;adaptiveData.consecutiveWrong=0;showMessage("Ho reso il gioco un po' più semplice per te! 🌟","hint")}adaptiveData.hintLevel>=2&&showHint();document.querySelectorAll(".answer-btn, .sequence-option").forEach(e=>{const t=e.textContent.trim(),n=String(gameState.userAnswer).trim();t!==n&&!t.includes(n)||e.classList.add("wrong")})}saveAdaptiveData();saveProgress()}function showHint(){const e={conteggio:"Conta lentamente ogni oggetto, uno alla volta. Usa le dita se ti aiuta! Puoi anche raggrupparli per 5.",'addizioni-visual':"Conta prima tutti gli oggetti del primo gruppo, poi quelli del secondo gruppo, infine sommali insieme!",'operazioni-entro-20':"Per le sottrazioni, parti dal numero più grande e togli quello più piccolo! Per le addizioni, inizia dal numero più grande e aggiungi.",'pattern-semplici':"Guarda attentamente: quale elemento si ripete? Osserva la sequenza dall'inizio e trova il ritmo!",'sequenze-base':"Pensa passo dopo passo: cosa fai per PRIMO, poi cosa viene DOPO? Segui l'ordine logico delle azioni!",'debugging-visuale':"Confronta con quello che dovrebbe essere giusto. Quale elemento è diverso o fuori posto?",'tabelline-base':"Ricorda: moltiplicare significa sommare tante volte lo stesso numero! 3×4 = 3+3+3+3",'loop-semplici':"Un loop ripete un'azione. Se devi fare qualcosa 5 volte, il loop esegue l'azione esattamente 5 volte!",'if-then-base':"Se succede una cosa, allora devi fare un'azione logica. Cosa faresti davvero in quella situazione?",'frazioni-visual':"Una frazione ti dice quante parti colorare del totale. Se è 2/4, colora 2 parti su 4! Puoi cambiare tipo di visualizzazione cliccando i pulsanti sopra.",'variabili-semplici':"Una variabile è come una scatola con un'etichetta. Leggi bene la domanda: cosa chiede esattamente?",'algoritmi-avanzati':"Pensa alla strategia più efficace e logica. Quale approccio risolverebbe davvero il problema?",'statistica-base':"Media = somma tutti i numeri ÷ quanti sono. Massimo = il più grande. Minimo = il più piccolo.",'progetti-completi':"Pensa a cosa è INDISPENSABILE per far funzionare quel tipo di progetto. Senza quale componente non funzionerebbe?",'collaborazione-digitale':"Nel coding moderno si usano strumenti specifici. Quale strumento risolve davvero quel problema nel team?",default:"Leggi attentamente la domanda e pensa con calma. Ogni indizio è importante! Puoi farcela!"};const t=e[currentGame]||e.default;document.getElementById("hintText").innerHTML=t;document.getElementById("hintContainer").style.display="flex"}function hideHint(){document.getElementById("hintContainer").style.display="none"}function generateNumberOptions(e,t){const n=[e],o=Math.max(1,e-5),a=e+5;for(;n.length<t;){const r=Math.floor(Math.random()*(a-o+1))+o;n.includes(r)||r<=0||n.push(r)}return n.sort(()=>Math.random()-.5)}function saveProgress(){localStorage.setItem("edutech_score",score.toString());localStorage.setItem("edutech_stars",stars.toString());localStorage.setItem("edutech_level",level.toString());updateStatsDisplay()}function resetProgress(){if(confirm("Sei sicuro di voler resettare tutti i progressi? (Utile per cambio classe)")){score=0;stars=0;level=1;adaptiveData={consecutiveCorrect:0,consecutiveWrong:0,totalQuestions:0,correctAnswers:0,currentDifficulty:1,maxDifficulty:5,hintLevel:0};localStorage.removeItem("edutech_score");localStorage.removeItem("edutech_stars");localStorage.removeItem("edutech_level");localStorage.removeItem("edutech_adaptive");updateStatsDisplay();document.getElementById("stats-bar").style.display="none"}}function showMessage(e,t){const n=document.getElementById("messageContainer");n.innerHTML=e;n.className=`message ${t} show`;setTimeout(()=>{hideMessage()},5e3)}function hideMessage(){const e=document.getElementById("messageContainer");e.classList.remove("show")}function backToHome(){document.getElementById("gamesSection").style.display="none";document.getElementById("gameInterface").style.display="none";document.getElementById("homepage").style.display="block";exitFullscreen()}function backToGames(){document.getElementById("gameInterface").style.display="none";document.getElementById("gamesSection").style.display="block";exitFullscreen()}function nextQuestion(){generateQuestion()}function toggleFullscreen(){const e=document.getElementById("gameInterface");document.fullscreenElement?document.exitFullscreen().then(()=>{e.classList.remove("fullscreen-mode")}):e.requestFullscreen().then(()=>{e.classList.add("fullscreen-mode")}).catch(e=>{console.log("Errore fullscreen:",e)})}function exitFullscreen(){document.fullscreenElement&&document.exitFullscreen().then(()=>{document.getElementById("gameInterface").classList.remove("fullscreen-mode")})}document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||document.getElementById("gameInterface").classList.remove("fullscreen-mode")});
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadAdaptiveData();
            
            // LOGICA SERVICE WORKER CORRETTA E COMPLETA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    if (reg.waiting) {
                        newWorker = reg.waiting;
                        showUpdateBanner();
                        return;
                    }
                    if (reg.installing) {
                        trackInstalling(reg.installing);
                        return;
                    }
                    reg.addEventListener('updatefound', () => {
                        trackInstalling(reg.installing);
                    });
                });

                // Questo listener risolve il problema del tasto "Aggiorna"
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.fullscreenElement) {
                    exitFullscreen();
                } else if (document.getElementById('gameInterface').style.display === 'block') {
                    backToGames();
                } else if (document.getElementById('gamesSection').style.display === 'block') {
                    backToHome();
                }
            }
            if (e.key === 'Enter' && !gameState.isAnswered) {
                if (document.getElementById('checkAnswerBtn').style.display !== 'none') {
                    checkAnswer();
                }
            }
            if (e.key >= '1' && e.key <= '4' && !gameState.isAnswered) {
                const answerBtns = document.querySelectorAll('.answer-btn');
                const index = parseInt(e.key) - 1;
                if (answerBtns[index]) {
                    answerBtns[index].click();
                }
            }
        });
    </script>
</body>
</html>
